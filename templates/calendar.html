{% extends "base.html" %}
{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock %}
{% block content %}
  <style>
    /*
      CSS custom properties for calendar sizing. These variables control
      the font size, cell height and cell width of the calendar. They are
      used throughout the table styles, and can be updated dynamically
      via JavaScript to implement zooming in/out.
    */
    :root {
      --calendar-font-size: 0.8rem;
      --calendar-cell-height: 50px;
      --calendar-cell-width: 160px;
    }
    /*
      –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤. –û—Ç—Ç–µ–Ω–∫–∏ –≤—ã–±—Ä–∞–Ω—ã –≤ –ø–∞—Å—Ç–µ–ª—å–Ω–æ–π –≥–∞–º–º–µ,
      —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –º–µ–Ω–µ–µ —è—Ä–∫–æ–π. –î–ª—è –±—Ä–æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º
      –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—É—é —à—Ç—Ä–∏—Ö–æ–≤–∫—É, –∫–∞–∫ –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ. –¢–µ–∫—Å—Ç—ã –æ–∫—Ä–∞—à–∏–≤–∞–µ–º
      –≤ –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã–µ —Ç–æ–Ω–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞.
    */
    /*
      –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, —á—Ç–æ–±—ã
      –≤–µ—Å—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–≥–ª—è–¥–µ–ª –±–æ–ª–µ–µ –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–º –∏ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–º. –¢—ë–º–Ω—ã–µ
      —Ü–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ö–æ—Ä–æ—à—É—é
      —á–∏—Ç–∞–µ–º–æ—Å—Ç—å. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –∏–º–µ—é—Ç –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—É—é —à—Ç—Ä–∏—Ö–æ–≤–∫—É,
      –Ω–æ —Ñ–æ–Ω –ø—Ä–∏ —ç—Ç–æ–º –æ—Å—Ç–∞—ë—Ç—Å—è —Å–≤–µ—Ç–ª–æ‚Äë–∂—ë–ª—Ç—ã–º.
    */
    .status-occupied {
      background-color: #e8f5e9 !important; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –∑–µ–ª—ë–Ω—ã–π */
      color: #2e7d32 !important;           /* —Ç—ë–º–Ω–æ‚Äë–∑–µ–ª—ë–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }
    .status-vacant {
      background-color: #fdecea !important; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –∫—Ä–∞—Å–Ω—ã–π */
      color: #922b21 !important;           /* —Ç—ë–º–Ω–æ‚Äë–∫—Ä–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }
    .status-booked {
      /* —Å–≤–µ—Ç–ª–æ‚Äë–∂—ë–ª—Ç—ã–π —Ñ–æ–Ω —Å –±–æ–ª–µ–µ –Ω–µ–∂–Ω–æ–π –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —à—Ç—Ä–∏—Ö–æ–≤–∫–æ–π */
      background-color: #fff9e6 !important;
      color: #856404 !important;
      background-image: repeating-linear-gradient(
        45deg,
        rgba(240, 235, 220, 0.4) 0px,
        rgba(240, 235, 220, 0.4) 10px,
        rgba(255, 255, 255, 0.4) 10px,
        rgba(255, 255, 255, 0.4) 20px
      ) !important;
    }
    .status-ready {
      background-color: #f5f6fa !important; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ‚Äë—Å–µ—Ä—ã–π */
      color: #495057 !important;           /* —Ç—ë–º–Ω–æ‚Äë—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
    }
    .status-cleaning {
      background-color: #f3e5f5 !important; /* —Å–≤–µ—Ç–ª—ã–π —Å–∏—Ä–µ–Ω–µ–≤—ã–π */
      color: #6a1b9a !important;            /* —Ç—ë–º–Ω–æ‚Äë—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç */
    }
    .status-hourly {
      background-color: #fff2e6 !important; /* —Å–≤–µ—Ç–ª—ã–π –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π */
      color: #8d6e63 !important;            /* –∫–æ—Ä–∏—á–Ω–µ–≤–∞—Ç—ã–π —Ç–µ–∫—Å—Ç */
    }

    /* –¢–∞–±–ª–∏—Ü–∞ –∏ —è—á–µ–π–∫–∏ */
    .calendar-table { 
      border-collapse: separate !important; 
      border-spacing: 0 !important; 

      /*
        Ensure the table's total width always matches the sum of its columns.
        Without this rule, some browsers may stretch the table to fill the
        horizontal scroll container, leaving blank space when you scroll
        horizontally after zooming out. Using `max-content` prevents that
        extra whitespace by sizing the table purely based on its contents.
      */
      width: max-content;
    }
    .calendar-table th, .calendar-table td { vertical-align: middle; }
    .calendar-table th { text-align: center; white-space: nowrap; }
    .calendar-table td {
      text-align: center;
      padding: 0;
      /* Use CSS variables for cell dimensions so they can be adjusted via zoom controls */
      height: var(--calendar-cell-height);
      min-width: var(--calendar-cell-width);
    }

    /* Apply the same dynamic height and width to header cells so they scale proportionally */
    .calendar-table th {
      height: var(--calendar-cell-height);
      min-width: var(--calendar-cell-width);
    }

    /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è –±–æ–ª–µ–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ –≤–∏–¥–∞,
       –ø–æ—Ö–æ–∂–µ–≥–æ –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å. */
    .calendar-table th,
    .calendar-table td {
      /* Use a variable for font size so it can be zoomed */
      font-size: var(--calendar-font-size);
      line-height: 1.2;
    }

    /* –û–±—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã */
    .calendar-table,
    .calendar-table th,
    .calendar-table td {
      border-color: #e3e6eb !important; /* —Å–≤–µ—Ç–ª–∞—è —Å–µ—Ä–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –º—è–≥–∫–æ–≥–æ –≤–∏–¥–∞ */
      border-width: 1px !important;
      border-style: solid;
    }

    /* –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä) */
    .calendar-table th:first-child,
    .calendar-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 5;
      background: #f3f4f6; /* —Å–≤–µ—Ç–ª–æ‚Äë—Å–µ—Ä—ã–π —Ñ–æ–Ω */
      font-weight: 700;
      border-left: 1px solid #dee2e6 !important;
      border-top: 1px solid #dee2e6 !important;
      border-bottom: 1px solid #dee2e6 !important;
      border-right: 0 !important; /* –ø—Ä–∞–≤—É—é —Ä–∏—Å—É–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç–æ–º */
      /* Reserve space at the bottom of the cell for the drag handle and
         allow absolutely positioned resizer elements to be positioned relative to the cell. */
      padding-bottom: 6px;
      overflow: visible;
    }
    .calendar-table th:first-child::after,
    .calendar-table td:first-child::after {
      content: "";
      position: absolute;
      top: 0;
      right: -1px;
      width: 1px;   /* —Ç–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
      height: 100%;
      background: #d0d4d7; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–∞—è —Å–µ—Ä–∞—è –ª–∏–Ω–∏—è */
      z-index: 6;
      pointer-events: none;
    }

    /* –°—Å—ã–ª–∫–∏ –≤ —è—á–µ–π–∫–∞—Ö */
    .calendar-table a {
      display: block;
      width: 100%;
      height: 100%;
      /* Match line-height to the dynamic cell height so the text vertically centers in scaled cells */
      line-height: var(--calendar-cell-height);
      text-decoration: none;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã */
    .calendar-container {
      background-color: #ffffff;
      border: none;
      border-radius: 0.25rem;
      padding: 0.5rem;
    }

    /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    .calendar-container .table-responsive { overflow-x: auto; }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥–æ–¥–∞–º –∏ –º–µ—Å—è—Ü–∞–º */
    .year-link,
    .month-link {
      /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —É —Å—Å—ã–ª–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤–¥–≤–æ–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –∏—Å—Ö–æ–¥–Ω—ã–º
         –¥–∏–∑–∞–π–Ω–æ–º: —Ä–∞–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å 1rem (–ø—Ä–∏–º–µ—Ä–Ω–æ 16px). –¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ–º
         0.8rem, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç—ã –≤—ã–≥–ª—è–¥–µ–ª–∏ –º–µ–Ω–µ–µ –≥—Ä–æ–º–æ–∑–¥–∫–∏–º–∏. */
      font-size: 0.8rem;
      color: #6c757d;
      text-decoration: none;
      padding-bottom: 2px;
      transition: color 0.2s;
    }
    /* –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ–¥/–º–µ—Å—è—Ü: –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ–º —Å–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º –∏ –¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ, –Ω–æ
       —Ç–æ–∂–µ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –í–º–µ—Å—Ç–æ 1.2rem —Ç–µ–ø–µ—Ä—å 1rem. */
    .year-link.active,
    .month-link.active {
      font-size: 1rem;
      color: #000000 !important;       /* —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞/–≥–æ–¥–∞ */
      border-bottom: 3px solid #119ffe !important; /* —Å–∏–Ω—è—è –ø–æ–ª–æ—Å–∞ —Å–Ω–∏–∑—É */
      font-weight: 600;
    }
    /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω–∏–π —Ü–≤–µ—Ç */
    .year-link:not(.active):hover,
    .month-link:not(.active):hover {
      color: #119ffe !important;
    }

    /* –£–ª—É—á—à–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü—ã: —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ —Å–µ—Ä–æ–≥–æ –¥–ª—è —á—ë—Ç–Ω—ã—Ö/–Ω–µ—á—ë—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
    .calendar-table thead th {
      background-color: #f7f9fc; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
    }
    .calendar-table tbody tr:nth-child(odd) td {
      background-color: #ffffff; /* –±–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è –Ω–µ—á—ë—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
    }
    .calendar-table tbody tr:nth-child(even) td {
      background-color: #fcfcfd; /* –ø–æ—á—Ç–∏ –±–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è —á—ë—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
    }
    /* –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–Ω–∞–∑–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä) –≤—ã–¥–µ–ª—è–µ–º —Å–≤–µ—Ç–ª–æ‚Äë—Å–µ—Ä—ã–º –∏ –¥–µ–ª–∞–µ–º –∂–∏—Ä–Ω—ã–º */
    .calendar-table tbody tr td:first-child,
    .calendar-table thead th:first-child {
      background-color: #f5f6fa;
      font-weight: 700;
    }

    /* –°—Ç–∏–ª—å –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ */
    .calendar-table td select.form-select {
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 2px 4px;
      font-size: var(--calendar-font-size);
      height: 100%;
    }
    .calendar-table td select.form-select:focus {
      box-shadow: none;
    }

    /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è: —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Å–∏–Ω—è—è –ø–æ–ª–æ—Å–∞ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
    .calendar-table thead th.active-day {
      color: #000000 !important;
      border-bottom: 3px solid #119ffe !important;
    }

    /*
      Sticky header row for the calendar. When the user scrolls down the
      list of apartments, the row containing the days of the month should
      remain visible at the top of the scroll container. We achieve this by
      making the header cells sticky with `top: 0`. A higher z-index
      ensures the header row stays above the table body cells. The first
      header cell ("–ö–≤–∞—Ä—Ç–∏—Ä–∞") is both horizontally and vertically sticky,
      so we also set a left offset and a higher z-index to keep it above
      overlapping content.
    */
    .calendar-table thead th {
      position: sticky;
      top: 0;
      z-index: 6;
    }
    .calendar-table thead th:first-child {
      left: 0;
      z-index: 7;
    }

    /* –°—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
    .single-line-link {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /*
      –ú–∞–ª–µ–Ω—å–∫–∏–π –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –≤ –Ω–∏–∂–Ω–µ–º –ª–µ–≤–æ–º —É–≥–ª—É —è—á–µ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.
      –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–µ–ª—ë–Ω–∞—è –≥–∞–ª–æ—á–∫–∞. –°–∞–º–∞ –≥–∞–ª–æ—á–∫–∞
      —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ –∏–∫–æ–Ω–∫—É Bootstrap Icons. –ú—ã –∑–∞–¥–∞—ë–º –Ω–µ–±–æ–ª—å—à–æ–π
      —Ä–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞, —Ç–æ–Ω–∫—É—é —Ä–∞–º–∫—É –∏ —Ü–µ–Ω—Ç—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ. –ï—Å–ª–∏
      –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –ø–æ–º–µ—á–µ–Ω –∫–ª–∞—Å—Å–æ–º `checked`, —Ñ–æ–Ω –∏ –≥—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è
      –∑–µ–ª—ë–Ω—ã–º–∏, –∞ –∏–∫–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è. –ë–µ–∑ –∫–ª–∞—Å—Å–∞ `checked`
      –∏–∫–æ–Ω–∫–∞ —Å–∫—Ä—ã—Ç–∞.
    */
    .checkmark-toggle {
      position: relative;
      width: 14px;
      height: 14px;
      border: 1px solid #adb5bd; /* —Å–≤–µ—Ç–ª–æ‚Äë—Å–µ—Ä—ã–π —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ */
      border-radius: 2px;
      background-color: #ffffff; /* –±–µ–ª—ã–π —Ñ–æ–Ω */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.65rem;
      color: #198754; /* –∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏ */
    }
    .checkmark-toggle i {
      display: none;
    }
    .checkmark-toggle.checked {
      background-color: #198754; /* –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω */
      border-color: #198754;     /* –∑–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞ */
      color: #ffffff;
    }
    .checkmark-toggle.checked i {
      display: block;
    }

    /* A small drag handle at the bottom of the first-column cells to resize row heights.
       Users can drag this bar up or down to adjust the height of all calendar cells at once.
       The handle itself is transparent by default and highlights on hover. */
    .row-resizer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
      cursor: ns-resize;
      background-color: transparent;
      z-index: 10;
    }
    .row-resizer:hover {
      background-color: #d0d4d7;
    }

  </style>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥–æ–¥–∞–º/–º–µ—Å—è—Ü–∞–º -->
  <div class="d-flex justify-content-between align-items-start flex-wrap mb-3">
    <div class="d-flex align-items-center mb-2 me-2">
      <h2 class="text-primary fw-bold fs-3 mb-0">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
    </div>
    <div class="navigation-wrapper text-center d-flex flex-column align-items-center">
      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥–æ–¥–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, —Ç–µ–∫—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥—ã) -->
      <div class="year-nav d-flex flex-wrap justify-content-center align-items-center">
        {% for y in year_range %}
          <a href="{{ url_for('calendar_view', year=y, month=month, complex=selected_complex) }}"
             class="year-link {% if y == year %}active{% endif %} ms-3">
            {{ y }}
          </a>
        {% endfor %}
      </div>
      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, —Ç–µ–∫—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü—ã) -->
      <div class="month-nav d-flex flex-wrap justify-content-center align-items-center">
        {% for item in month_links %}
          <a href="{{ url_for('calendar_view', year=item.year, month=item.month, complex=selected_complex) }}"
             class="month-link {% if item.month == month and item.year == year %}active{% endif %} ms-3">
            {{ month_names[item.month] }}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- –ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
  <div class="row g-1 align-items-end mb-2 mt-3">
    <div class="col d-flex align-items-end">
      <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ñ–ö –∏ –¥–∞—Ç (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞) -->
      <form method="get" id="search_form" class="row g-2 align-items-end me-2">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <!-- Dropdown to filter by residential complex -->
        <div class="col-auto">
          <label for="complex" class="form-label small">–ñ–ö</label>
          <select id="complex" name="complex" class="form-select">
            <option value="" {% if not selected_complex %}selected{% endif %}>–í—Å–µ –ñ–ö</option>
            {% for c in complexes %}
              <option value="{{ c }}" {% if selected_complex == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Start date -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
          <label for="start_date" class="form-label small">–ó–∞–µ–∑–¥ —Å</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <!-- End date -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
          <label for="end_date" class="form-label small">–ø–æ</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>
        {# –ö–Ω–æ–ø–∫–∞ –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤—ã–Ω–µ—Å–µ–Ω–∞ –Ω–∏–∂–µ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π –î–µ–ø–æ–∑–∏—Ç—ã #}
      </form>
      <form method="get" action="{{ url_for('verify_guest') }}" class="row g-1 align-items-end ms-3">
        <!-- –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã -->
        <div class="col-auto clickable-field" onclick="this.querySelector('select').focus();">
          <label for="verify_country_code" class="form-label small">–ö–æ–¥</label>
          <select id="verify_country_code" name="country_code" class="form-select">
            <option value="+7" data-mask="(XXX) XXX XX XX" data-length="10" data-flag="üá∞üáø" selected>üá∞üáø +7</option>
            <option value="+1" data-mask="(XXX) XXX-XXXX" data-length="10" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
            <option value="+44" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá¨üáß">üá¨üáß +44</option>
            <option value="+49" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá©üá™">üá©üá™ +49</option>
            <option value="+81" data-mask="(XXXX) XXX XXX" data-length="9" data-flag="üáØüáµ">üáØüáµ +81</option>
          </select>
        </div>
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').focus();">
          <label for="verify_phone" class="form-label small">–¢–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è</label>
          <input type="tel" id="verify_phone" name="phone" class="form-control" placeholder="(XXX) XXX XX XX" required
                 list="guest-phones">
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–º–µ—Ä–∞ -->
        <div class="col-auto">
          <button type="submit" class="btn btn-secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ —Ñ–æ—Ä–º–∞–º–∏: –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∏ –î–µ–ø–æ–∑–∏—Ç—ã -->
  <div class="row g-2 mb-3">
    {% if available_rooms is none %}
      <div class="col-auto">
        <!--
          –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É search_form.
          –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã name –∏ value –∫ –∫–Ω–æ–ø–∫–µ, —á—Ç–æ–±—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É
          –≤ –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä show_free=1. –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
          —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç.
        -->
        <button type="submit"
                class="btn btn-primary"
                form="search_form"
                name="show_free"
                value="1">
          –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ
        </button>
      </div>
    {% else %}
      <div class="col-auto">
        {#
          –ü–æ—Å–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä –∫–Ω–æ–ø–∫—É –º–µ–Ω—è–µ–º –Ω–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ".
          –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –±—ã–ª –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω –∫–Ω–æ–ø–∫–æ–π "–ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ" (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç),
          —Ç–æ –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º show_free=1 –∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ñ–ö, —Ç–µ–º —Å–∞–º—ã–º
          –ø–æ–∫–∞–∑—ã–≤–∞—è —Å–≤–æ–±–æ–¥–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ –≤—Å–µ–º –∫–æ–º–ø–ª–µ–∫—Å–∞–º. –ï—Å–ª–∏ –∂–µ –ø–æ–∏—Å–∫ –±—ã–ª –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç,
          —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é, —Å–æ—Ö—Ä–∞–Ω—è—è –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å.
        #}
        <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ" –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é —Å–æ –≤—Å–µ–º–∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏ -->
        <form method="get">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button type="submit" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
        </form>
      </div>
    {% endif %}
    <div class="col-auto">
      <a href="{{ url_for('deposits') }}" class="btn btn-outline-secondary">–î–µ–ø–æ–∑–∏—Ç—ã</a>
    </div>
  </div>

  {% if available_rooms is not none %}
    <div class="alert alert-success">
      <strong>–°–≤–æ–±–æ–¥–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã:</strong>
      {% if available_rooms %}
        {% for r in available_rooms %}
          ‚Ññ{{ r['room_number'] }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä
      {% endif %}
    </div>
  {% endif %}

  <!-- –°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç–µ–∫—Å—Ç —Å–ª–µ–≤–∞, –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="mb-2 mb-md-0">
      <strong>–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:</strong>
      <span class="me-3">–ë—Ä–æ–Ω—å: <strong>{{ summary_counts['booked'] }}</strong></span>
      <span class="me-3">–ù–µ –∑–∞—Å–µ–ª–µ–Ω–æ: <strong>{{ summary_counts['vacant'] }}</strong></span>
    </div>
    <!-- Zoom controls: magnifying glass with minus/plus.  We keep the same IDs
         so the existing JavaScript can find and control these buttons. -->
    <div class="btn-group btn-group-sm" role="group" aria-label="Zoom controls">
      <button type="button" class="btn btn-outline-secondary" id="zoom-out-btn" title="–£–º–µ–Ω—å—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
        <i class="bi bi-zoom-out"></i>
      </button>
      <span id="zoom-display" class="btn btn-light disabled" style="pointer-events: none;">100%</span>
      <button type="button" class="btn btn-outline-secondary" id="zoom-in-btn" title="–£–≤–µ–ª–∏—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
        <i class="bi bi-zoom-in"></i>
      </button>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
  <div class="calendar-container mt-3">
    <!-- Make the calendar vertically scrollable: limit height so the whole page fits in the viewport.  
         When there are many apartments, this div will provide its own scrollbar instead of extending the page. -->
    <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
      <table class="table table-bordered table-sm calendar-table">
        <thead class="table-light">
          <tr>
            <th scope="col">–ö–≤–∞—Ä—Ç–∏—Ä–∞</th>
            {% for d in days %}
            {# Determine if this day is the currently selected day.  If so, add the active-day class #}
            <th scope="col"
                data-day="{{ d.day }}"
                data-date="{{ d.isoformat() }}"
                class="py-1 {% if selected_date and d == selected_date %}active-day{% endif %}">
              {#
                When clicking on a day header we do not want to jump the selected day to
                the first column. Instead of setting scroll_date to the clicked day,
                we preserve the existing scroll_date (or today's date if none). This
                prevents the calendar from resetting its horizontal scroll when the page
                reloads.
              #}
              <a href="{{ url_for('calendar_view', year=year, month=month, complex=selected_complex, selected_date=d.isoformat(), scroll_date=d.isoformat()) }}"
                 class="text-decoration-none text-reset d-block">
                <span class="d-block"><span class="text-muted">{{ weekday_abbrs[d.weekday()] }}</span> {{ d.day }}</span>
              </a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rooms %}
            <tr>
              <th scope="row">
                {% if row.room['listing_url'] %}
                  <a href="{{ row.room['listing_url'] }}" target="_blank" class="text-decoration-none text-reset d-block single-line-link">
                    {{ row.room['room_number'] }}
                  </a>
                {% else %}
                  <span class="d-block single-line-link">{{ row.room['room_number'] }}</span>
                {% endif %}
                <!-- Resizer handle: dragging this will adjust the height of all calendar rows -->
                <div class="row-resizer"></div>
              </th>
              {% for cell in row.days %}
                <td class="status-{{ cell.status }} p-0 position-relative">
                  <div class="d-flex flex-column h-100">
                    <!-- –í–µ—Ä—Ö: –≤—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ -->
                    <form method="post" action="{{ url_for('set_room_status', room_id=row.room['id'], date_str=cell.date) }}"
                          class="flex-grow-1 border-bottom">
                      <select name="status" class="form-select form-select-sm py-0" onchange="this.form.submit()">
                        <option value="occupied" {% if cell.status == 'occupied' %}selected{% endif %}>–ó–∞—Å–µ–ª–µ–Ω–æ</option>
                        <option value="vacant"   {% if cell.status == 'vacant'   %}selected{% endif %}>–ù–µ –∑–∞—Å–µ–ª–µ–Ω–æ</option>
                        <option value="booked"   {% if cell.status == 'booked'   %}selected{% endif %}>–ë—Ä–æ–Ω—å</option>
                        <option value="ready"    {% if cell.status == 'ready'    %}selected{% endif %}>–ì–æ—Ç–æ–≤–∞</option>
                        <option value="cleaning" {% if cell.status == 'cleaning' %}selected{% endif %}>–£–±–æ—Ä–∫–∞</option>
                        <option value="hourly"   {% if cell.status == 'hourly'   %}selected{% endif %}>–ß–∞—Å–æ–≤–∏–∫–∏</option>
                      </select>
                    </form>
                    <!-- –ù–∏–∑: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (—Ü–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏) –∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏ -->
                    {% if cell.booking %}
                      <a href="{{ url_for('edit_booking', booking_id=cell.booking['id'], scroll_date=cell.date.isoformat()) }}"
                         class="text-reset flex-grow-1 py-1"
                         data-bs-toggle="tooltip"
                         data-bs-html="true"
                         title="–ì–æ—Å—Ç—å: {{ guest_names[cell.booking['guest_id']] }}&lt;br&gt;–ü–µ—Ä–∏–æ–¥: {{ cell.booking['check_in_date'] }} ‚Äì {{ cell.booking['check_out_date'] }}&lt;br&gt;–¶–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏: {{ (cell.booking['rate_per_day']|currency) if cell.booking['rate_per_day'] else '' }}&lt;br&gt;–û–±—â–∞—è —Å—É–º–º–∞: {{ (cell.booking['total_amount']|currency) if cell.booking['total_amount'] else '' }}&lt;br&gt;–û–ø–ª–∞—á–µ–Ω–æ: {{ (cell.booking['paid_amount']|currency) if cell.booking['paid_amount'] else '' }}">
                        <small>{{ (cell.booking['rate_per_day']|currency) if cell.booking['rate_per_day'] else '' }}</small>
                      </a>
                    {% else %}
                      {% if cell.date >= today %}
                        <a href="{{ url_for('add_booking', room_id=row.room['id'], check_in=cell.date, check_out=cell.date, scroll_date=cell.date.isoformat()) }}"
                           class="text-reset flex-grow-1 py-1 text-decoration-none"
                           title="–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">&nbsp;</a>
                      {% else %}
                        <span class="d-block flex-grow-1 py-1">&nbsp;</span>
                      {% endif %}
                    {% endif %}
                  </div>
                  <!-- –ú–∞–ª–µ–Ω—å–∫–∏–π –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏/–≥–∞–ª–æ—á–∫–∏ -->
                  <div class="checkmark-toggle position-absolute bottom-0 start-0 m-1" onclick="this.classList.toggle('checked');">
                    <i class="bi bi-check-lg"></i>
                  </div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–∫–≤–∞—Ä—Ç–∏—Ä—ã) -->
  <div class="d-flex justify-content-start mt-2">
    <a href="{{ url_for('add_room') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        var scrollDate = '{{ (scroll_date.isoformat() if scroll_date else today.isoformat()) }}';
        // Expose the scroll date globally so that it can be reused when updating the zoom
        window.calendarScrollDate = scrollDate;
        var targetCol = document.querySelector('.calendar-table thead th[data-date="' + scrollDate + '"]');
        var container = document.querySelector('.calendar-container .table-responsive');
        if (container) {
          /*
            Try to restore the horizontal scroll position based on the saved column index.
            We store the index of the first visible date column (excluding the sticky room
            column) in localStorage as 'calendarScrollIndex'. If present, compute the
            offset using the current cell width. Otherwise fall back to positioning based
            on the provided scrollDate and the header cell index.
          */
          var savedIdxStr = localStorage.getItem('calendarScrollIndex');
          var savedIdx = savedIdxStr ? parseInt(savedIdxStr, 10) : null;
          var cellWidthStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cellWidth = parseFloat(cellWidthStr) || 160;
          var offset = 0;
          if (!isNaN(savedIdx) && savedIdx !== null) {
            offset = savedIdx * cellWidth;
            // Update the global scroll date based on the saved index
            var headerCells = document.querySelectorAll('.calendar-table thead th[data-date]');
            if (headerCells && savedIdx < headerCells.length) {
              var dt = headerCells[savedIdx].getAttribute('data-date');
              if (dt) {
                window.calendarScrollDate = dt;
              }
            }
          } else if (targetCol) {
            var index = targetCol.cellIndex;
            if (typeof index !== 'number' || isNaN(index)) index = 1;
            offset = (index - 1) * cellWidth;
          }
          if (offset < 0) offset = 0;
          var maxScroll = container.scrollWidth - container.clientWidth;
          if (offset > maxScroll) offset = maxScroll;
          container.scrollLeft = offset;
        }
      } catch (e) {
        console.error(e);
      }
    });
  </script>

  <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Å—Ç—è -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var verifyCountrySelect = document.getElementById('verify_country_code');
      var verifyPhoneInput = document.getElementById('verify_phone');
      if (verifyCountrySelect && verifyPhoneInput) {
        var currentMask = '';
        var currentLength = 0;

        function updatePlaceholder() {
          var selected = verifyCountrySelect.options[verifyCountrySelect.selectedIndex];
          currentMask = selected.getAttribute('data-mask');
          currentLength = parseInt(selected.getAttribute('data-length'), 10) || 10;
          verifyPhoneInput.placeholder = currentMask;
          // –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–¥–∞ –æ—á–∏—â–∞–µ–º –≤–≤–µ–¥—ë–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
          verifyPhoneInput.value = '';
        }

        function formatNumber(digits) {
          var result = '';
          var digitIndex = 0;
          for (var i = 0; i < currentMask.length; i++) {
            var ch = currentMask[i];
            if (ch === 'X') {
              if (digitIndex < digits.length) {
                result += digits[digitIndex++];
              } else {
                break;
              }
            } else {
              result += ch;
            }
          }
          return result;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –ø—Ä–∏ –≤–≤–æ–¥–µ —Ü–∏—Ñ—Ä
        verifyPhoneInput.addEventListener('input', function () {
          var digits = verifyPhoneInput.value.replace(/\D/g, '');
          if (digits.length > currentLength) {
            digits = digits.slice(0, currentLength);
          }
          verifyPhoneInput.value = formatNumber(digits);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Backspace: —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
        verifyPhoneInput.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace') {
            e.preventDefault();
            var digits = verifyPhoneInput.value.replace(/\D/g, '');
            if (digits.length > 0) {
              digits = digits.slice(0, -1);
              verifyPhoneInput.value = formatNumber(digits);
            }
          }
        });

        // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
        verifyPhoneInput.addEventListener('focus', function () {
          var len = verifyPhoneInput.value.length;
          verifyPhoneInput.setSelectionRange(len, len);
        });

        // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å–∫—É –∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
        verifyCountrySelect.addEventListener('change', function () {
          updatePlaceholder();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–∫–∏
        updatePlaceholder();
      }
    });
  </script>

  <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è (zoom in/out) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Current zoom level and bounds
      // Try to load the previous zoom level from localStorage; default to 1
      var savedZoom = localStorage.getItem('calendarZoom');
      var zoomLevel = savedZoom ? parseFloat(savedZoom) : 1;
      var maxZoom = 1.5;
      var minZoom = 0.5;
      var step = 0.1;
      // Base values correspond to the defaults defined in :root
      var baseFont = 0.8; // rem
      var baseHeight = 50; // px
      var baseWidth = 160; // px

      function updateZoom() {
        // Update CSS custom properties to scale the calendar dimensions
        document.documentElement.style.setProperty('--calendar-font-size', (baseFont * zoomLevel).toFixed(2) + 'rem');
        document.documentElement.style.setProperty('--calendar-cell-height', (baseHeight * zoomLevel).toFixed(0) + 'px');
        document.documentElement.style.setProperty('--calendar-cell-width', (baseWidth * zoomLevel).toFixed(0) + 'px');
        // Update the displayed percentage
        if (zoomDisplay) {
          zoomDisplay.textContent = Math.round(zoomLevel * 100) + '%';
        }
        // Persist the current zoom level in localStorage so it survives page reloads
        try {
          localStorage.setItem('calendarZoom', zoomLevel.toFixed(2));
        } catch (e) {
          // Ignore storage errors (e.g. private browsing)
        }
        // After changing the dimensions, adjust horizontal scroll so that
        // the relative position remains consistent. If a saved scroll index
        // exists (the index of the first visible date column), use it to
        // compute the offset. Otherwise fall back to using the stored
        // calendarScrollDate from the initial alignment.
        var container = document.querySelector('.calendar-container .table-responsive');
        if (container) {
          var savedIdxStr2 = localStorage.getItem('calendarScrollIndex');
          var savedIdx2 = savedIdxStr2 ? parseInt(savedIdxStr2, 10) : null;
          var cellWidthStr2 = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cellWidth2 = parseFloat(cellWidthStr2);
          if (isNaN(cellWidth2) || !cellWidth2) {
            cellWidth2 = baseWidth * zoomLevel;
          }
          var off = 0;
          if (!isNaN(savedIdx2) && savedIdx2 !== null) {
            off = savedIdx2 * cellWidth2;
          } else {
            // fallback: use calendarScrollDate to find the target column
            var scrollDateValue2 = window.calendarScrollDate;
            if (scrollDateValue2) {
              var target2 = document.querySelector('.calendar-table thead th[data-date="' + scrollDateValue2 + '"]');
              if (target2) {
                var idx2 = target2.cellIndex;
                if (typeof idx2 !== 'number' || isNaN(idx2)) {
                  idx2 = 1;
                }
                off = (idx2 - 1) * cellWidth2;
              }
            }
          }
          if (off < 0) off = 0;
          var maxScroll2 = container.scrollWidth - container.clientWidth;
          if (off > maxScroll2) off = maxScroll2;
          container.scrollLeft = off;
        }
      }

      var zoomInBtn = document.getElementById('zoom-in-btn');
      var zoomOutBtn = document.getElementById('zoom-out-btn');
      var zoomDisplay = document.getElementById('zoom-display');
      if (zoomInBtn && zoomOutBtn) {
        zoomInBtn.addEventListener('click', function () {
          if (zoomLevel < maxZoom) {
            zoomLevel += step;
            updateZoom();
          }
        });
        zoomOutBtn.addEventListener('click', function () {
          if (zoomLevel > minZoom) {
            zoomLevel -= step;
            updateZoom();
          }
        });
      }

      // Track horizontal scrolling to persist the current column index. When
      // the user scrolls horizontally, compute which date column is at the
      // left edge and store its index in localStorage. Also update
      // window.calendarScrollDate so zooming keeps the same date visible.
      var scrollContainer = document.querySelector('.calendar-container .table-responsive');
      if (scrollContainer) {
        scrollContainer.addEventListener('scroll', function () {
          var cwStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cw = parseFloat(cwStr);
          if (isNaN(cw) || !cw) cw = baseWidth * zoomLevel;
          var idx = Math.round(scrollContainer.scrollLeft / cw);
          if (idx < 0) idx = 0;
          try {
            localStorage.setItem('calendarScrollIndex', idx.toString());
          } catch (e) {
            // Ignore storage errors
          }
          // Update global scroll date to correspond to the current leftmost visible date
          var headerCells = document.querySelectorAll('.calendar-table thead th[data-date]');
          if (headerCells && idx < headerCells.length) {
            var newDate = headerCells[idx].getAttribute('data-date');
            if (newDate) {
              window.calendarScrollDate = newDate;
            }
          }
        });
      }

      // Initialize the displayed zoom percentage on load
      if (zoomDisplay) {
        zoomDisplay.textContent = Math.round(zoomLevel * 100) + '%';
      }
      // Apply zoom immediately on page load to reflect stored value
      updateZoom();
    });
  </script>

  <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.
       –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —è—á–µ–π–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
       –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö —è—á–µ–µ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è. -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var isResizing = false;
      var startY = 0;
      var startHeight = 0;
      var minHeight = 30; // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
      var maxHeight = 200; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö

      function onMouseMove(e) {
        if (!isResizing) return;
        var dy = e.clientY - startY;
        var newHeight = startHeight + dy;
        if (newHeight < minHeight) newHeight = minHeight;
        if (newHeight > maxHeight) newHeight = maxHeight;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é CSS, –æ—Ç–≤–µ—á–∞—é—â—É—é –∑–∞ –≤—ã—Å–æ—Ç—É —è—á–µ–µ–∫
        document.documentElement.style.setProperty('--calendar-cell-height', newHeight + 'px');
      }

      function onMouseUp(e) {
        if (!isResizing) return;
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Å–µ–º —Ä–µ–∑–∞–π–∑–µ—Ä–∞–º –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ
      var resizers = document.querySelectorAll('.row-resizer');
      resizers.forEach(function (resizer) {
        resizer.addEventListener('mousedown', function (e) {
          e.preventDefault();
          isResizing = true;
          startY = e.clientY;
          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É —è—á–µ–π–∫–∏ –∏–∑ CSS‚Äë–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
          var heightStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-height');
          startHeight = parseFloat(heightStr) || 0;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    });
  </script>
{% endblock %}
