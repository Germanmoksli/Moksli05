{% extends "base.html" %}
{% block title %}Календарь{% endblock %}
{% block content %}
  <style>
    /*
      CSS custom properties for calendar sizing. These variables control
      the font size, cell height and cell width of the calendar. They are
      used throughout the table styles, and can be updated dynamically
      via JavaScript to implement zooming in/out.
    */
    :root {
      --calendar-font-size: 0.8rem;
      --calendar-cell-height: 50px;
      --calendar-cell-width: 160px;
    }
    /*
      Цвета статусов. Оттенки выбраны в пастельной гамме,
      чтобы таблица выглядела менее яркой. Для брони используем
      диагональную штриховку, как в прототипе. Тексты окрашиваем
      в более тёмные тона для контраста.
    */
    /*
      Цвета статусов. Используем очень светлые пастельные оттенки, чтобы
      весь календарь выглядел более приглушённым и гармоничным. Тёмные
      цвета используются только для текста, чтобы обеспечить хорошую
      читаемость. Бронированные ячейки имеют диагональную штриховку,
      но фон при этом остаётся светло‑жёлтым.
    */
    .status-occupied {
      background-color: #e8f5e9 !important; /* очень светлый зелёный */
      color: #2e7d32 !important;           /* тёмно‑зелёный текст */
    }
    .status-vacant {
      background-color: #fdecea !important; /* очень светлый красный */
      color: #922b21 !important;           /* тёмно‑красный текст */
    }
    .status-booked {
      /* светло‑жёлтый фон с более нежной диагональной штриховкой */
      background-color: #fff9e6 !important;
      color: #856404 !important;
      background-image: repeating-linear-gradient(
        45deg,
        rgba(240, 235, 220, 0.4) 0px,
        rgba(240, 235, 220, 0.4) 10px,
        rgba(255, 255, 255, 0.4) 10px,
        rgba(255, 255, 255, 0.4) 20px
      ) !important;
    }
    .status-ready {
      background-color: #f5f6fa !important; /* очень светло‑серый */
      color: #495057 !important;           /* тёмно‑серый текст */
    }
    .status-cleaning {
      background-color: #f3e5f5 !important; /* светлый сиреневый */
      color: #6a1b9a !important;            /* тёмно‑фиолетовый текст */
    }
    .status-hourly {
      background-color: #fff2e6 !important; /* светлый персиковый */
      color: #8d6e63 !important;            /* коричневатый текст */
    }

    /* Таблица и ячейки */
    .calendar-table { 
      border-collapse: separate !important; 
      border-spacing: 0 !important; 

      /*
        Ensure the table's total width always matches the sum of its columns.
        Without this rule, some browsers may stretch the table to fill the
        horizontal scroll container, leaving blank space when you scroll
        horizontally after zooming out. Using `max-content` prevents that
        extra whitespace by sizing the table purely based on its contents.
      */
      width: max-content;
    }
    .calendar-table th, .calendar-table td { vertical-align: middle; }
    .calendar-table th { text-align: center; white-space: nowrap; }
    .calendar-table td {
      text-align: center;
      padding: 0;
      /* Use CSS variables for cell dimensions so they can be adjusted via zoom controls */
      height: var(--calendar-cell-height);
      min-width: var(--calendar-cell-width);
    }

    /* Apply the same dynamic height and width to header cells so they scale proportionally */
    .calendar-table th {
      height: var(--calendar-cell-height);
      min-width: var(--calendar-cell-width);
    }

    /* Уменьшаем размер шрифта в таблице для более аккуратного вида,
       похожего на референс. */
    .calendar-table th,
    .calendar-table td {
      /* Use a variable for font size so it can be zoomed */
      font-size: var(--calendar-font-size);
      line-height: 1.2;
    }

    /* Общие границы */
    .calendar-table,
    .calendar-table th,
    .calendar-table td {
      border-color: #e3e6eb !important; /* светлая серая рамка для мягкого вида */
      border-width: 1px !important;
      border-style: solid;
    }

    /* Первая колонка (наименования квартир) */
    .calendar-table th:first-child,
    .calendar-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 5;
      background: #f3f4f6; /* светло‑серый фон */
      font-weight: 700;
      border-left: 1px solid #dee2e6 !important;
      border-top: 1px solid #dee2e6 !important;
      border-bottom: 1px solid #dee2e6 !important;
      border-right: 0 !important; /* правую рисуем псевдоэлементом */
      /* Reserve space at the bottom of the cell for the drag handle and
         allow absolutely positioned resizer elements to be positioned relative to the cell. */
      padding-bottom: 6px;
      overflow: visible;
    }
    .calendar-table th:first-child::after,
    .calendar-table td:first-child::after {
      content: "";
      position: absolute;
      top: 0;
      right: -1px;
      width: 1px;   /* тонкая линия выделения */
      height: 100%;
      background: #d0d4d7; /* очень светлая серая линия */
      z-index: 6;
      pointer-events: none;
    }

    /* Ссылки в ячейках */
    .calendar-table a {
      display: block;
      width: 100%;
      height: 100%;
      /* Match line-height to the dynamic cell height so the text vertically centers in scaled cells */
      line-height: var(--calendar-cell-height);
      text-decoration: none;
    }

    /* Контейнер таблицы */
    .calendar-container {
      background-color: #ffffff;
      border: none;
      border-radius: 0.25rem;
      padding: 0.5rem;
    }

    /* Горизонтальная прокрутка */
    .calendar-container .table-responsive { overflow-x: auto; }

    /* Навигация по годам и месяцам */
    .year-link,
    .month-link {
      /* Уменьшаем размер шрифта у ссылок навигации примерно вдвое по сравнению с исходным
         дизайном: раньше использовалось 1rem (примерно 16px). Теперь применяем
         0.8rem, чтобы элементы выглядели менее громоздкими. */
      font-size: 0.8rem;
      color: #6c757d;
      text-decoration: none;
      padding-bottom: 2px;
      transition: color 0.2s;
    }
    /* Активный год/месяц: подчёркиваем синим цветом и делаем текст чуть крупнее, но
       тоже уменьшенный относительно исходного значения. Вместо 1.2rem теперь 1rem. */
    .year-link.active,
    .month-link.active {
      font-size: 1rem;
      color: #000000 !important;       /* чёрный текст для текущего месяца/года */
      border-bottom: 3px solid #119ffe !important; /* синяя полоса снизу */
      font-weight: 600;
    }
    /* При наведении на неактивные ссылки также используем синий цвет */
    .year-link:not(.active):hover,
    .month-link:not(.active):hover {
      color: #119ffe !important;
    }

    /* Улучшаем внешний вид таблицы: разные оттенки серого для чётных/нечётных строк */
    .calendar-table thead th {
      background-color: #f7f9fc; /* очень светлый фон для заголовков */
    }
    .calendar-table tbody tr:nth-child(odd) td {
      background-color: #ffffff; /* белый фон для нечётных строк */
    }
    .calendar-table tbody tr:nth-child(even) td {
      background-color: #fcfcfd; /* почти белый фон для чётных строк */
    }
    /* Первый столбец (названия квартир) выделяем светло‑серым и делаем жирным */
    .calendar-table tbody tr td:first-child,
    .calendar-table thead th:first-child {
      background-color: #f5f6fa;
      font-weight: 700;
    }

    /* Стиль выпадающих списков со статусами внутри ячеек */
    .calendar-table td select.form-select {
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 2px 4px;
      font-size: var(--calendar-font-size);
      height: 100%;
    }
    .calendar-table td select.form-select:focus {
      box-shadow: none;
    }

    /* Выделение выбранного дня: чёрный текст и синяя полоса под заголовком */
    .calendar-table thead th.active-day {
      color: #000000 !important;
      border-bottom: 3px solid #119ffe !important;
    }

    /*
      Sticky header row for the calendar. When the user scrolls down the
      list of apartments, the row containing the days of the month should
      remain visible at the top of the scroll container. We achieve this by
      making the header cells sticky with `top: 0`. A higher z-index
      ensures the header row stays above the table body cells. The first
      header cell ("Квартира") is both horizontally and vertically sticky,
      so we also set a left offset and a higher z-index to keep it above
      overlapping content.
    */
    .calendar-table thead th {
      position: sticky;
      top: 0;
      z-index: 6;
    }
    .calendar-table thead th:first-child {
      left: 0;
      z-index: 7;
    }

    /* Ссылки на объекты в календаре: одна строка с многоточием при переполнении */
    .single-line-link {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /*
      Маленький квадратик в нижнем левом углу ячейки календаря.
      При клике на квадратик появляется зелёная галочка. Сама галочка
      реализована через иконку Bootstrap Icons. Мы задаём небольшой
      размер квадрата, тонкую рамку и центруем содержимое. Если
      квадратик помечен классом `checked`, фон и граница становятся
      зелёными, а иконка внутри отображается. Без класса `checked`
      иконка скрыта.
    */
    .checkmark-toggle {
      position: relative;
      width: 14px;
      height: 14px;
      border: 1px solid #adb5bd; /* светло‑серый цвет рамки */
      border-radius: 2px;
      background-color: #ffffff; /* белый фон */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.65rem;
      color: #198754; /* зелёный цвет иконки */
    }
    .checkmark-toggle i {
      display: none;
    }
    .checkmark-toggle.checked {
      background-color: #198754; /* зелёный фон */
      border-color: #198754;     /* зелёная рамка */
      color: #ffffff;
    }
    .checkmark-toggle.checked i {
      display: block;
    }

    /* A small drag handle at the bottom of the first-column cells to resize row heights.
       Users can drag this bar up or down to adjust the height of all calendar cells at once.
       The handle itself is transparent by default and highlights on hover. */
    .row-resizer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
      cursor: ns-resize;
      background-color: transparent;
      z-index: 10;
    }
    .row-resizer:hover {
      background-color: #d0d4d7;
    }

  </style>

  <!-- Заголовок и навигация по годам/месяцам -->
  <div class="d-flex justify-content-between align-items-start flex-wrap mb-3">
    <div class="d-flex align-items-center mb-2 me-2">
      <h2 class="text-primary fw-bold fs-3 mb-0">Календарь</h2>
    </div>
    <div class="navigation-wrapper text-center d-flex flex-column align-items-center">
      <!-- Навигация по годам (показываем предыдущий, текущий и следующий годы) -->
      <div class="year-nav d-flex flex-wrap justify-content-center align-items-center">
        {% for y in year_range %}
          <a href="{{ url_for('calendar_view', year=y, month=month, complex=selected_complex) }}"
             class="year-link {% if y == year %}active{% endif %} ms-3">
            {{ y }}
          </a>
        {% endfor %}
      </div>
      <!-- Навигация по месяцам (показываем предыдущий, текущий и следующий месяцы) -->
      <div class="month-nav d-flex flex-wrap justify-content-center align-items-center">
        {% for item in month_links %}
          <a href="{{ url_for('calendar_view', year=item.year, month=item.month, complex=selected_complex) }}"
             class="month-link {% if item.month == month and item.year == year %}active{% endif %} ms-3">
            {{ month_names[item.month] }}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Поиск квартир и проверка телефона в одной строке -->
  <div class="row g-1 align-items-end mb-2 mt-3">
    <div class="col d-flex align-items-end">
      <!-- Форма фильтров ЖК и дат (всегда видна) -->
      <form method="get" id="search_form" class="row g-2 align-items-end me-2">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <!-- Dropdown to filter by residential complex -->
        <div class="col-auto">
          <label for="complex" class="form-label small">ЖК</label>
          <select id="complex" name="complex" class="form-select">
            <option value="" {% if not selected_complex %}selected{% endif %}>Все ЖК</option>
            {% for c in complexes %}
              <option value="{{ c }}" {% if selected_complex == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Start date -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
          <label for="start_date" class="form-label small">Заезд с</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <!-- End date -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
          <label for="end_date" class="form-label small">по</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>
        {# Кнопка Показать свободные вынесена ниже рядом с кнопкой Депозиты #}
      </form>
      <form method="get" action="{{ url_for('verify_guest') }}" class="row g-1 align-items-end ms-3">
        <!-- Код страны -->
        <div class="col-auto clickable-field" onclick="this.querySelector('select').focus();">
          <label for="verify_country_code" class="form-label small">Код</label>
          <select id="verify_country_code" name="country_code" class="form-select">
            <option value="+7" data-mask="(XXX) XXX XX XX" data-length="10" data-flag="🇰🇿" selected>🇰🇿 +7</option>
            <option value="+1" data-mask="(XXX) XXX-XXXX" data-length="10" data-flag="🇺🇸">🇺🇸 +1</option>
            <option value="+44" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="🇬🇧">🇬🇧 +44</option>
            <option value="+49" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="🇩🇪">🇩🇪 +49</option>
            <option value="+81" data-mask="(XXXX) XXX XXX" data-length="9" data-flag="🇯🇵">🇯🇵 +81</option>
          </select>
        </div>
        <!-- Поле ввода номера телефона -->
        <div class="col-auto clickable-field" onclick="this.querySelector('input').focus();">
          <label for="verify_phone" class="form-label small">Телефон гостя</label>
          <input type="tel" id="verify_phone" name="phone" class="form-control" placeholder="(XXX) XXX XX XX" required
                 list="guest-phones">
        </div>
        <!-- Кнопка для проверки номера -->
        <div class="col-auto">
          <button type="submit" class="btn btn-secondary">Проверить</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Кнопки под формами: Показать все и Депозиты -->
  <div class="row g-2 mb-3">
    {% if available_rooms is none %}
      <div class="col-auto">
        <!--
          Кнопка "Показать свободные" отправляет форму фильтрации по идентификатору search_form.
          Мы добавляем атрибуты name и value к кнопке, чтобы только при клике на эту кнопку
          в запрос передавался параметр show_free=1. Этот параметр обрабатывается
          серверной частью и вызывает поиск свободных квартир без указания дат.
        -->
        <button type="submit"
                class="btn btn-primary"
                form="search_form"
                name="show_free"
                value="1">
          Показать свободные
        </button>
      </div>
    {% else %}
      <div class="col-auto">
        {#
          После отображения списка свободных квартир кнопку меняем на "Показать все".
          Если поиск был инициирован кнопкой "Показать свободные" (без указания дат),
          то мы отправляем запрос с параметром show_free=1 и без фильтра по ЖК, тем самым
          показывая свободные квартиры по всем комплексам. Если же поиск был по диапазону дат,
          то возвращаемся к исходному календарю, сохраняя выбранный комплекс.
        #}
        <!-- Кнопка "Показать все" всегда возвращает к календарю со всеми квартирами -->
        <form method="get">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button type="submit" class="btn btn-primary">Показать все</button>
        </form>
      </div>
    {% endif %}
    <div class="col-auto">
      <a href="{{ url_for('deposits') }}" class="btn btn-outline-secondary">Депозиты</a>
    </div>
  </div>

  {% if available_rooms is not none %}
    <div class="alert alert-success">
      <strong>Свободные квартиры:</strong>
      {% if available_rooms %}
        {% for r in available_rooms %}
          №{{ r['room_number'] }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        Нет свободных квартир
      {% endif %}
    </div>
  {% endif %}

  <!-- Сводка по статусам и масштабирование: текст слева, кнопки справа -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="mb-2 mb-md-0">
      <strong>Сводка по статусам:</strong>
      <span class="me-3">Бронь: <strong>{{ summary_counts['booked'] }}</strong></span>
      <span class="me-3">Не заселено: <strong>{{ summary_counts['vacant'] }}</strong></span>
    </div>
    <!-- Zoom controls: magnifying glass with minus/plus.  We keep the same IDs
         so the existing JavaScript can find and control these buttons. -->
    <div class="btn-group btn-group-sm" role="group" aria-label="Zoom controls">
      <button type="button" class="btn btn-outline-secondary" id="zoom-out-btn" title="Уменьшить масштаб">
        <i class="bi bi-zoom-out"></i>
      </button>
      <span id="zoom-display" class="btn btn-light disabled" style="pointer-events: none;">100%</span>
      <button type="button" class="btn btn-outline-secondary" id="zoom-in-btn" title="Увеличить масштаб">
        <i class="bi bi-zoom-in"></i>
      </button>
    </div>
  </div>

  <!-- Таблица календаря -->
  <div class="calendar-container mt-3">
    <!-- Make the calendar vertically scrollable: limit height so the whole page fits in the viewport.  
         When there are many apartments, this div will provide its own scrollbar instead of extending the page. -->
    <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
      <table class="table table-bordered table-sm calendar-table">
        <thead class="table-light">
          <tr>
            <th scope="col">Квартира</th>
            {% for d in days %}
            {# Determine if this day is the currently selected day.  If so, add the active-day class #}
            <th scope="col"
                data-day="{{ d.day }}"
                data-date="{{ d.isoformat() }}"
                class="py-1 {% if selected_date and d == selected_date %}active-day{% endif %}">
              {#
                When clicking on a day header we do not want to jump the selected day to
                the first column. Instead of setting scroll_date to the clicked day,
                we preserve the existing scroll_date (or today's date if none). This
                prevents the calendar from resetting its horizontal scroll when the page
                reloads.
              #}
              <a href="{{ url_for('calendar_view', year=year, month=month, complex=selected_complex, selected_date=d.isoformat(), scroll_date=d.isoformat()) }}"
                 class="text-decoration-none text-reset d-block">
                <span class="d-block"><span class="text-muted">{{ weekday_abbrs[d.weekday()] }}</span> {{ d.day }}</span>
              </a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rooms %}
            <tr>
              <th scope="row">
                {% if row.room['listing_url'] %}
                  <a href="{{ row.room['listing_url'] }}" target="_blank" class="text-decoration-none text-reset d-block single-line-link">
                    {{ row.room['room_number'] }}
                  </a>
                {% else %}
                  <span class="d-block single-line-link">{{ row.room['room_number'] }}</span>
                {% endif %}
                <!-- Resizer handle: dragging this will adjust the height of all calendar rows -->
                <div class="row-resizer"></div>
              </th>
              {% for cell in row.days %}
                <td class="status-{{ cell.status }} p-0 position-relative">
                  <div class="d-flex flex-column h-100">
                    <!-- Верх: выбор статуса -->
                    <form method="post" action="{{ url_for('set_room_status', room_id=row.room['id'], date_str=cell.date) }}"
                          class="flex-grow-1 border-bottom">
                      <select name="status" class="form-select form-select-sm py-0" onchange="this.form.submit()">
                        <option value="occupied" {% if cell.status == 'occupied' %}selected{% endif %}>Заселено</option>
                        <option value="vacant"   {% if cell.status == 'vacant'   %}selected{% endif %}>Не заселено</option>
                        <option value="booked"   {% if cell.status == 'booked'   %}selected{% endif %}>Бронь</option>
                        <option value="ready"    {% if cell.status == 'ready'    %}selected{% endif %}>Готова</option>
                        <option value="cleaning" {% if cell.status == 'cleaning' %}selected{% endif %}>Уборка</option>
                        <option value="hourly"   {% if cell.status == 'hourly'   %}selected{% endif %}>Часовики</option>
                      </select>
                    </form>
                    <!-- Низ: отображение стоимости (цена за сутки) и переход на редактирование брони -->
                    {% if cell.booking %}
                      <a href="{{ url_for('edit_booking', booking_id=cell.booking['id'], scroll_date=cell.date.isoformat()) }}"
                         class="text-reset flex-grow-1 py-1"
                         data-bs-toggle="tooltip"
                         data-bs-html="true"
                         title="Гость: {{ guest_names[cell.booking['guest_id']] }}&lt;br&gt;Период: {{ cell.booking['check_in_date'] }} – {{ cell.booking['check_out_date'] }}&lt;br&gt;Цена за сутки: {{ (cell.booking['rate_per_day']|currency) if cell.booking['rate_per_day'] else '' }}&lt;br&gt;Общая сумма: {{ (cell.booking['total_amount']|currency) if cell.booking['total_amount'] else '' }}&lt;br&gt;Оплачено: {{ (cell.booking['paid_amount']|currency) if cell.booking['paid_amount'] else '' }}">
                        <small>{{ (cell.booking['rate_per_day']|currency) if cell.booking['rate_per_day'] else '' }}</small>
                      </a>
                    {% else %}
                      {% if cell.date >= today %}
                        <a href="{{ url_for('add_booking', room_id=row.room['id'], check_in=cell.date, check_out=cell.date, scroll_date=cell.date.isoformat()) }}"
                           class="text-reset flex-grow-1 py-1 text-decoration-none"
                           title="Создать бронирование">&nbsp;</a>
                      {% else %}
                        <span class="d-block flex-grow-1 py-1">&nbsp;</span>
                      {% endif %}
                    {% endif %}
                  </div>
                  <!-- Маленький квадратик для отметки готовности/галочки -->
                  <div class="checkmark-toggle position-absolute bottom-0 start-0 m-1" onclick="this.classList.toggle('checked');">
                    <i class="bi bi-check-lg"></i>
                  </div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Кнопка для добавления нового объекта (квартиры) -->
  <div class="d-flex justify-content-start mt-2">
    <a href="{{ url_for('add_room') }}" class="btn btn-primary">Добавить объект</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        var scrollDate = '{{ (scroll_date.isoformat() if scroll_date else today.isoformat()) }}';
        // Expose the scroll date globally so that it can be reused when updating the zoom
        window.calendarScrollDate = scrollDate;
        var targetCol = document.querySelector('.calendar-table thead th[data-date="' + scrollDate + '"]');
        var container = document.querySelector('.calendar-container .table-responsive');
        if (container) {
          /*
            Try to restore the horizontal scroll position based on the saved column index.
            We store the index of the first visible date column (excluding the sticky room
            column) in localStorage as 'calendarScrollIndex'. If present, compute the
            offset using the current cell width. Otherwise fall back to positioning based
            on the provided scrollDate and the header cell index.
          */
          var savedIdxStr = localStorage.getItem('calendarScrollIndex');
          var savedIdx = savedIdxStr ? parseInt(savedIdxStr, 10) : null;
          var cellWidthStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cellWidth = parseFloat(cellWidthStr) || 160;
          var offset = 0;
          if (!isNaN(savedIdx) && savedIdx !== null) {
            offset = savedIdx * cellWidth;
            // Update the global scroll date based on the saved index
            var headerCells = document.querySelectorAll('.calendar-table thead th[data-date]');
            if (headerCells && savedIdx < headerCells.length) {
              var dt = headerCells[savedIdx].getAttribute('data-date');
              if (dt) {
                window.calendarScrollDate = dt;
              }
            }
          } else if (targetCol) {
            var index = targetCol.cellIndex;
            if (typeof index !== 'number' || isNaN(index)) index = 1;
            offset = (index - 1) * cellWidth;
          }
          if (offset < 0) offset = 0;
          var maxScroll = container.scrollWidth - container.clientWidth;
          if (offset > maxScroll) offset = maxScroll;
          container.scrollLeft = offset;
        }
      } catch (e) {
        console.error(e);
      }
    });
  </script>

  <!-- Скрипт для маски номера телефона в форме проверки гостя -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var verifyCountrySelect = document.getElementById('verify_country_code');
      var verifyPhoneInput = document.getElementById('verify_phone');
      if (verifyCountrySelect && verifyPhoneInput) {
        var currentMask = '';
        var currentLength = 0;

        function updatePlaceholder() {
          var selected = verifyCountrySelect.options[verifyCountrySelect.selectedIndex];
          currentMask = selected.getAttribute('data-mask');
          currentLength = parseInt(selected.getAttribute('data-length'), 10) || 10;
          verifyPhoneInput.placeholder = currentMask;
          // при смене кода очищаем введённый номер
          verifyPhoneInput.value = '';
        }

        function formatNumber(digits) {
          var result = '';
          var digitIndex = 0;
          for (var i = 0; i < currentMask.length; i++) {
            var ch = currentMask[i];
            if (ch === 'X') {
              if (digitIndex < digits.length) {
                result += digits[digitIndex++];
              } else {
                break;
              }
            } else {
              result += ch;
            }
          }
          return result;
        }

        // Форматируем номер при вводе цифр
        verifyPhoneInput.addEventListener('input', function () {
          var digits = verifyPhoneInput.value.replace(/\D/g, '');
          if (digits.length > currentLength) {
            digits = digits.slice(0, currentLength);
          }
          verifyPhoneInput.value = formatNumber(digits);
        });

        // Обработка Backspace: удаляем последнюю цифру вне зависимости от разделителей
        verifyPhoneInput.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace') {
            e.preventDefault();
            var digits = verifyPhoneInput.value.replace(/\D/g, '');
            if (digits.length > 0) {
              digits = digits.slice(0, -1);
              verifyPhoneInput.value = formatNumber(digits);
            }
          }
        });

        // При фокусе ставим курсор в конец
        verifyPhoneInput.addEventListener('focus', function () {
          var len = verifyPhoneInput.value.length;
          verifyPhoneInput.setSelectionRange(len, len);
        });

        // При смене кода страны обновляем маску и очищаем поле
        verifyCountrySelect.addEventListener('change', function () {
          updatePlaceholder();
        });

        // Инициализация маски
        updatePlaceholder();
      }
    });
  </script>

  <!-- Скрипт для управления масштабом календаря (zoom in/out) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Current zoom level and bounds
      // Try to load the previous zoom level from localStorage; default to 1
      var savedZoom = localStorage.getItem('calendarZoom');
      var zoomLevel = savedZoom ? parseFloat(savedZoom) : 1;
      var maxZoom = 1.5;
      var minZoom = 0.5;
      var step = 0.1;
      // Base values correspond to the defaults defined in :root
      var baseFont = 0.8; // rem
      var baseHeight = 50; // px
      var baseWidth = 160; // px

      function updateZoom() {
        // Update CSS custom properties to scale the calendar dimensions
        document.documentElement.style.setProperty('--calendar-font-size', (baseFont * zoomLevel).toFixed(2) + 'rem');
        document.documentElement.style.setProperty('--calendar-cell-height', (baseHeight * zoomLevel).toFixed(0) + 'px');
        document.documentElement.style.setProperty('--calendar-cell-width', (baseWidth * zoomLevel).toFixed(0) + 'px');
        // Update the displayed percentage
        if (zoomDisplay) {
          zoomDisplay.textContent = Math.round(zoomLevel * 100) + '%';
        }
        // Persist the current zoom level in localStorage so it survives page reloads
        try {
          localStorage.setItem('calendarZoom', zoomLevel.toFixed(2));
        } catch (e) {
          // Ignore storage errors (e.g. private browsing)
        }
        // After changing the dimensions, adjust horizontal scroll so that
        // the relative position remains consistent. If a saved scroll index
        // exists (the index of the first visible date column), use it to
        // compute the offset. Otherwise fall back to using the stored
        // calendarScrollDate from the initial alignment.
        var container = document.querySelector('.calendar-container .table-responsive');
        if (container) {
          var savedIdxStr2 = localStorage.getItem('calendarScrollIndex');
          var savedIdx2 = savedIdxStr2 ? parseInt(savedIdxStr2, 10) : null;
          var cellWidthStr2 = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cellWidth2 = parseFloat(cellWidthStr2);
          if (isNaN(cellWidth2) || !cellWidth2) {
            cellWidth2 = baseWidth * zoomLevel;
          }
          var off = 0;
          if (!isNaN(savedIdx2) && savedIdx2 !== null) {
            off = savedIdx2 * cellWidth2;
          } else {
            // fallback: use calendarScrollDate to find the target column
            var scrollDateValue2 = window.calendarScrollDate;
            if (scrollDateValue2) {
              var target2 = document.querySelector('.calendar-table thead th[data-date="' + scrollDateValue2 + '"]');
              if (target2) {
                var idx2 = target2.cellIndex;
                if (typeof idx2 !== 'number' || isNaN(idx2)) {
                  idx2 = 1;
                }
                off = (idx2 - 1) * cellWidth2;
              }
            }
          }
          if (off < 0) off = 0;
          var maxScroll2 = container.scrollWidth - container.clientWidth;
          if (off > maxScroll2) off = maxScroll2;
          container.scrollLeft = off;
        }
      }

      var zoomInBtn = document.getElementById('zoom-in-btn');
      var zoomOutBtn = document.getElementById('zoom-out-btn');
      var zoomDisplay = document.getElementById('zoom-display');
      if (zoomInBtn && zoomOutBtn) {
        zoomInBtn.addEventListener('click', function () {
          if (zoomLevel < maxZoom) {
            zoomLevel += step;
            updateZoom();
          }
        });
        zoomOutBtn.addEventListener('click', function () {
          if (zoomLevel > minZoom) {
            zoomLevel -= step;
            updateZoom();
          }
        });
      }

      // Track horizontal scrolling to persist the current column index. When
      // the user scrolls horizontally, compute which date column is at the
      // left edge and store its index in localStorage. Also update
      // window.calendarScrollDate so zooming keeps the same date visible.
      var scrollContainer = document.querySelector('.calendar-container .table-responsive');
      if (scrollContainer) {
        scrollContainer.addEventListener('scroll', function () {
          var cwStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-width');
          var cw = parseFloat(cwStr);
          if (isNaN(cw) || !cw) cw = baseWidth * zoomLevel;
          var idx = Math.round(scrollContainer.scrollLeft / cw);
          if (idx < 0) idx = 0;
          try {
            localStorage.setItem('calendarScrollIndex', idx.toString());
          } catch (e) {
            // Ignore storage errors
          }
          // Update global scroll date to correspond to the current leftmost visible date
          var headerCells = document.querySelectorAll('.calendar-table thead th[data-date]');
          if (headerCells && idx < headerCells.length) {
            var newDate = headerCells[idx].getAttribute('data-date');
            if (newDate) {
              window.calendarScrollDate = newDate;
            }
          }
        });
      }

      // Initialize the displayed zoom percentage on load
      if (zoomDisplay) {
        zoomDisplay.textContent = Math.round(zoomLevel * 100) + '%';
      }
      // Apply zoom immediately on page load to reflect stored value
      updateZoom();
    });
  </script>

  <!-- Скрипт для изменения высоты строк календаря.
       Пользователь может перетащить нижнюю границу ячейки с названием квартиры
       вверх или вниз, чтобы изменить высоту всех ячеек календаря. -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var isResizing = false;
      var startY = 0;
      var startHeight = 0;
      var minHeight = 30; // минимальная высота в пикселях
      var maxHeight = 200; // максимальная высота в пикселях

      function onMouseMove(e) {
        if (!isResizing) return;
        var dy = e.clientY - startY;
        var newHeight = startHeight + dy;
        if (newHeight < minHeight) newHeight = minHeight;
        if (newHeight > maxHeight) newHeight = maxHeight;
        // Обновляем кастомную переменную CSS, отвечающую за высоту ячеек
        document.documentElement.style.setProperty('--calendar-cell-height', newHeight + 'px');
      }

      function onMouseUp(e) {
        if (!isResizing) return;
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      // Назначаем обработчики всем резайзерам в первом столбце
      var resizers = document.querySelectorAll('.row-resizer');
      resizers.forEach(function (resizer) {
        resizer.addEventListener('mousedown', function (e) {
          e.preventDefault();
          isResizing = true;
          startY = e.clientY;
          // Получаем текущую высоту ячейки из CSS‑переменной
          var heightStr = getComputedStyle(document.documentElement).getPropertyValue('--calendar-cell-height');
          startHeight = parseFloat(heightStr) || 0;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    });
  </script>
{% endblock %}
