{% extends "base.html" %}
{% block title %}{{ room['room_number'] }}{% endblock %}
{% block content %}
  <div class="container mt-4">
    <h2 class="text-primary fw-bold fs-3 mb-3">{{ room['room_number'] }}</h2>
    <div class="row">
      <!-- Left column: photo gallery and map -->
      <div class="col-md-6 mb-4">
        {% if photos and photos|length > 0 %}
        <div class="gallery-container">
          <div class="main-image-container position-relative">
            {# Display the first photo as the main image without cropping; constrain maximum height #}
            <img id="mainImage" src="{{ photos[0] }}" class="img-fluid rounded" alt="Фото квартиры" style="width: 100%; max-height: 300px; object-fit: contain;">
            <!-- Navigation arrows overlay -->
            <button type="button" id="prevBtn" class="btn btn-light position-absolute top-50 start-0 translate-middle-y shadow-sm" style="opacity: 0.7;">
              &lsaquo;
            </button>
            <button type="button" id="nextBtn" class="btn btn-light position-absolute top-50 end-0 translate-middle-y shadow-sm" style="opacity: 0.7;">
              &rsaquo;
            </button>
          </div>
          <!-- Thumbnails -->
          <div class="thumbs d-flex flex-wrap mt-2">
            {% for photo_src in photos %}
              <img src="{{ photo_src }}" class="img-thumbnail me-2 mb-2" alt="Превью фото" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;">
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% if room['latitude'] and room['longitude'] %}
        <!-- Map underneath the gallery -->
        <div id="mapid" class="rounded mt-3" style="height: 300px;"></div>
        {% endif %}
      </div>
      <!-- Right column: apartment details -->
      <div class="col-md-6">
        <ul class="list-unstyled mb-3">
          {% if room['num_rooms'] %}<li><strong>Количество комнат:</strong> {{ room['num_rooms'] }}</li>{% endif %}
          {% if room['floor'] is not none %}
            <li><strong>Этаж:</strong> {{ room['floor'] }}{% if room['floors_total'] is not none %}/{{ room['floors_total'] }}{% endif %}</li>
          {% endif %}
          {% if room['area_total'] is not none %}
            <li><strong>Площадь:</strong> {{ room['area_total'] }} м²{% if room['area_kitchen'] is not none %} (кухня {{ room['area_kitchen'] }} м²){% endif %}</li>
          {% endif %}
          {% if room['condition'] %}
            {% set condition_map = {'fresh': 'Свежий ремонт, новая мебель', 'good': 'Не свежий, но аккуратный ремонт', 'none': 'Без ремонта'} %}
            <li><strong>Состояние:</strong> {{ condition_map.get(room['condition'], room['condition']) }}</li>
          {% endif %}
          {% if room['kitchen_studio'] is not none %}
            <li><strong>Кухня студия:</strong> {{ 'Да' if room['kitchen_studio'] else 'Нет' }}</li>
          {% endif %}
          {% if room['price_per_night'] is not none %}
            <li><strong>Цена за сутки:</strong> {{ room['price_per_night'] }} ₸</li>
          {% endif %}
          {% if room['country'] or room['city'] or room['street'] or room['house_number'] %}
            <li><strong>Адрес:</strong>
              {{ room['country'] or '' }}{% if room['city'] %}, {{ room['city'] }}{% endif %}{% if room['street'] %}, {{ room['street'] }}{% endif %}{% if room['house_number'] %}, {{ room['house_number'] }}{% endif %}
            </li>
          {% endif %}
          {% if room['residential_complex'] %}<li><strong>Жилой комплекс:</strong> {{ room['residential_complex'] }}</li>{% endif %}
          {% if room['listing_url'] %}<li><strong>Ссылка на объявление:</strong> <a href="{{ room['listing_url'] }}" target="_blank">Перейти</a></li>{% endif %}
        </ul>
      </div>
    </div>
    <a href="{{ url_for('public_listings') }}" class="btn btn-secondary mt-2">Назад в каталог</a>
  </div>
  {# Fullscreen lightbox overlay for viewing photos on a dark backdrop #}
  <div id="lightboxOverlay" class="lightbox-overlay d-none justify-content-center align-items-center">
    <div class="position-relative">
      <img id="lightboxImage" src="{{ photos[0] if photos else '' }}" class="img-fluid" alt="Фото квартиры" style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
      <button type="button" id="lightboxPrevBtn" class="btn btn-light position-absolute top-50 start-0 translate-middle-y shadow-sm" style="opacity: 0.7;">
        &lsaquo;
      </button>
      <button type="button" id="lightboxNextBtn" class="btn btn-light position-absolute top-50 end-0 translate-middle-y shadow-sm" style="opacity: 0.7;">
        &rsaquo;
      </button>
      <button type="button" id="lightboxCloseBtn" class="btn btn-light position-absolute top-0 end-0 m-3 shadow-sm" style="opacity: 0.7; font-size: 1.5rem;">
        &times;
      </button>
    </div>
  </div>
  <style>
    /* Fullscreen overlay styles for lightbox */
    .lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1050;
    }
  </style>
  {% if room['latitude'] and room['longitude'] %}
  <!-- Подключение Leaflet для отображения карты -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var lat = {{ room['latitude'] }};
      var lon = {{ room['longitude'] }};
      var map = L.map('mapid').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      L.marker([lat, lon]).addTo(map);
    });
  </script>
  {% endif %}
  <!-- Галерея фотографий: навигация между изображениями -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var thumbnails = Array.from(document.querySelectorAll('.thumbs img'));
      var mainImage = document.getElementById('mainImage');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');
      // Elements for fullscreen lightbox
      var lightboxOverlay = document.getElementById('lightboxOverlay');
      var lightboxImage = document.getElementById('lightboxImage');
      var lightboxPrevBtn = document.getElementById('lightboxPrevBtn');
      var lightboxNextBtn = document.getElementById('lightboxNextBtn');
      var lightboxCloseBtn = document.getElementById('lightboxCloseBtn');
      var currentIndex = 0;
      function showImage(index) {
        if (!thumbnails.length) return;
        if (index < 0 || index >= thumbnails.length) return;
        currentIndex = index;
        if (mainImage) {
          mainImage.src = thumbnails[index].src;
        }
      }
      if (prevBtn) {
        prevBtn.addEventListener('click', function() {
          if (!thumbnails.length) return;
          var newIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
          showImage(newIndex);
          // If lightbox is open, update the overlay image as well
          if (lightboxOverlay && !lightboxOverlay.classList.contains('d-none') && lightboxImage) {
            lightboxImage.src = thumbnails[newIndex].src;
          }
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener('click', function() {
          if (!thumbnails.length) return;
          var newIndex = (currentIndex + 1) % thumbnails.length;
          showImage(newIndex);
          // If lightbox is open, update the overlay image as well
          if (lightboxOverlay && !lightboxOverlay.classList.contains('d-none') && lightboxImage) {
            lightboxImage.src = thumbnails[newIndex].src;
          }
        });
      }
      thumbnails.forEach(function(thumb, index) {
        thumb.addEventListener('click', function() {
          showImage(index);
          // Also update the lightbox image if it's open
          if (lightboxOverlay && !lightboxOverlay.classList.contains('d-none') && lightboxImage) {
            lightboxImage.src = thumb.src;
            currentIndex = index;
          }
        });
      });

      // Show lightbox when clicking on the main image
      if (mainImage && lightboxOverlay && lightboxImage) {
        mainImage.addEventListener('click', function() {
          if (!thumbnails.length) return;
          lightboxImage.src = mainImage.src;
          lightboxOverlay.classList.remove('d-none');
        });
      }
      // Close lightbox when clicking on close button
      if (lightboxCloseBtn && lightboxOverlay) {
        lightboxCloseBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          lightboxOverlay.classList.add('d-none');
        });
      }
      // Navigate within lightbox
      if (lightboxPrevBtn) {
        lightboxPrevBtn.addEventListener('click', function(e) {
          if (!thumbnails.length) return;
          e.stopPropagation();
          var newIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
          showImage(newIndex);
          if (lightboxImage) {
            lightboxImage.src = thumbnails[newIndex].src;
          }
        });
      }
      if (lightboxNextBtn) {
        lightboxNextBtn.addEventListener('click', function(e) {
          if (!thumbnails.length) return;
          e.stopPropagation();
          var newIndex = (currentIndex + 1) % thumbnails.length;
          showImage(newIndex);
          if (lightboxImage) {
            lightboxImage.src = thumbnails[newIndex].src;
          }
        });
      }
      // Close lightbox when clicking on the dark overlay area
      if (lightboxOverlay) {
        lightboxOverlay.addEventListener('click', function(e) {
          // Only close if the click target is the overlay itself, not the content
          if (e.target === lightboxOverlay) {
            lightboxOverlay.classList.add('d-none');
          }
        });
      }
    });
  </script>
{% endblock %}