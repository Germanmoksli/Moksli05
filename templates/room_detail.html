{% extends "base.html" %}
{% block title %}{{ room['room_number'] }}{% endblock %}
{% block content %}
  <div class="container mt-4">
    <h2 class="text-primary fw-bold fs-3 mb-3">{{ room['room_number'] }}</h2>
    <div class="row">
      <!-- Левая колонка: галерея и карта -->
      <div class="col-md-7">
        {% if photos and photos|length > 0 %}
        {# Основное изображение. Оборачиваем в position-relative контейнер,
           чтобы разместить стрелки и водяной знак поверх изображения. #}
        <div class="position-relative image-container mb-2" style="height: 350px;">
          <img id="mainImage" src="{{ photos[0] }}" class="img-fluid rounded w-100 h-100" style="object-fit: contain;" alt="Фото квартиры">
          <span class="watermark">moksli.com</span>
          <button id="prevBtn" type="button" class="btn btn-light btn-sm position-absolute top-50 start-0 translate-middle-y">&#x2039;</button>
          <button id="nextBtn" type="button" class="btn btn-light btn-sm position-absolute top-50 end-0 translate-middle-y">&#x203a;</button>
        </div>
        {# Миниатюры. Каждая миниатюра содержит data-index для JS. #}
        <div class="d-flex flex-wrap gap-2 mb-3">
          {% for idx, photo_src in enumerate(photos) %}
          <div class="position-relative image-container" style="width: 100px; height: 100px; cursor:pointer;">
            <img src="{{ photo_src }}" class="img-fluid rounded border thumbnail-img w-100 h-100" data-index="{{ idx }}" style="object-fit: cover;" alt="Миниатюра">
            <span class="watermark">moksli.com</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if room['latitude'] and room['longitude'] %}
        <div id="mapid" style="height: 250px;"></div>
        {% endif %}
      </div>
      <!-- Правая колонка: детали о квартире -->
      <div class="col-md-5">
        <ul class="list-unstyled mb-3">
          {% if room['num_rooms'] %}<li><strong>Количество комнат:</strong> {{ room['num_rooms'] }}</li>{% endif %}
          {% if room['floor'] is not none %}
            <li><strong>Этаж:</strong> {{ room['floor'] }}{% if room['floors_total'] is not none %}/{{ room['floors_total'] }}{% endif %}</li>
          {% endif %}
          {% if room['area_total'] is not none %}
            <li><strong>Площадь:</strong> {{ room['area_total'] }} м²{% if room['area_kitchen'] is not none %} (кухня {{ room['area_kitchen'] }} м²){% endif %}</li>
          {% endif %}
          {% if room['condition'] %}
            {% set condition_map = {'fresh': 'Свежий ремонт, новая мебель', 'good': 'Не свежий, но аккуратный ремонт', 'none': 'Без ремонта'} %}
            <li><strong>Состояние:</strong> {{ condition_map.get(room['condition'], room['condition']) }}</li>
          {% endif %}
          {% if room['kitchen_studio'] is not none %}
            <li><strong>Кухня студия:</strong> {{ 'Да' if room['kitchen_studio'] else 'Нет' }}</li>
          {% endif %}
          {% if room['price_per_night'] is not none %}
            <li><strong>Цена за сутки:</strong> {{ room['price_per_night'] }} ₸</li>
          {% endif %}
          {% if room['country'] or room['city'] or room['street'] or room['house_number'] %}
            <li><strong>Адрес:</strong>
              {{ room['country'] or '' }}{% if room['city'] %}, {{ room['city'] }}{% endif %}{% if room['street'] %}, {{ room['street'] }}{% endif %}{% if room['house_number'] %}, {{ room['house_number'] }}{% endif %}
            </li>
          {% endif %}
          {% if room['residential_complex'] %}<li><strong>Жилой комплекс:</strong> {{ room['residential_complex'] }}</li>{% endif %}
          {% if room['listing_url'] %}<li><strong>Ссылка на объявление:</strong> <a href="{{ room['listing_url'] }}" target="_blank">Перейти</a></li>{% endif %}
        </ul>
      </div>
    </div>
    <a href="{{ url_for('public_listings') }}" class="btn btn-secondary mt-4">Назад в каталог</a>

    {# Полноэкранный просмотр галереи: появляется при клике на основное изображение #}
    {% if photos and photos|length > 0 %}
    <div id="fullscreenOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75" style="z-index: 1050;">
      <div class="d-flex flex-column h-100 align-items-center justify-content-center">
        <div class="position-relative w-75" style="max-height: 80%;">
          <img id="fsMainImage" src="{{ photos[0] }}" class="img-fluid w-100 h-100" style="object-fit: contain;" alt="Фото квартиры">
          <span class="watermark">moksli.com</span>
          <button id="fsPrevBtn" type="button" class="btn btn-light btn-sm position-absolute top-50 start-0 translate-middle-y">&#x2039;</button>
          <button id="fsNextBtn" type="button" class="btn btn-light btn-sm position-absolute top-50 end-0 translate-middle-y">&#x203a;</button>
          <button id="fsCloseBtn" type="button" class="btn btn-light btn-sm position-absolute top-0 end-0 m-3">&times;</button>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3 justify-content-center" style="max-width: 90%;">
          {% for idx, photo_src in enumerate(photos) %}
          <div class="position-relative image-container" style="width: 80px; height: 80px; cursor:pointer;">
            <img src="{{ photo_src }}" class="img-fluid rounded border fs-thumbnail w-100 h-100" data-index="{{ idx }}" style="object-fit: cover;" alt="Миниатюра">
            <span class="watermark">moksli.com</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Подключаем Leaflet только если есть координаты -->
  {% if room['latitude'] and room['longitude'] %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  {% endif %}
  <!-- Дополнительные стили для водяных знаков -->
  <style>
    .image-container { position: relative; overflow: hidden; }
    .image-container .watermark {
      position: absolute;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 700;
      font-size: 0.9rem;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
      pointer-events: none;
      z-index: 1;
    }
  </style>
  <!-- Скрипты для галереи, карты и водяных знаков -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Инициализация карты при наличии координат
      {% if room['latitude'] and room['longitude'] %}
      var lat = {{ room['latitude'] }};
      var lon = {{ room['longitude'] }};
      var map = L.map('mapid').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      L.marker([lat, lon]).addTo(map);
      {% endif %}

      // Размещение водяных знаков в случайных позициях
      const watermarks = document.querySelectorAll('.image-container .watermark');
      watermarks.forEach(function(wm) {
        const x = Math.random() * 60;
        const y = Math.random() * 60;
        wm.style.left = x + '%';
        wm.style.top = y + '%';
      });

      // Галерея: основное изображение и миниатюры
      const mainImage = document.getElementById('mainImage');
      const thumbnails = document.querySelectorAll('.thumbnail-img');
      let currentIndex = 0;
      function showImage(idx) {
        if (!thumbnails.length) return;
        if (idx < 0) idx = thumbnails.length - 1;
        if (idx >= thumbnails.length) idx = 0;
        currentIndex = idx;
        mainImage.src = thumbnails[idx].src;
        // Синхронизируем полноэкранный режим, если он открыт
        const fsMain = document.getElementById('fsMainImage');
        if (fsMain) {
          fsMain.src = thumbnails[idx].src;
        }
      }
      // События для стрелок
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      if (prevBtn && nextBtn) {
        prevBtn.addEventListener('click', function() { showImage(currentIndex - 1); });
        nextBtn.addEventListener('click', function() { showImage(currentIndex + 1); });
      }
      // События для миниатюр
      thumbnails.forEach(function(thumb, index) {
        thumb.addEventListener('click', function() { showImage(index); });
      });

      // Полноэкранный режим
      const overlay = document.getElementById('fullscreenOverlay');
      const fsPrevBtn = document.getElementById('fsPrevBtn');
      const fsNextBtn = document.getElementById('fsNextBtn');
      const fsCloseBtn = document.getElementById('fsCloseBtn');
      const fsThumbnails = document.querySelectorAll('.fs-thumbnail');
      // Показать полноэкранный режим при клике на основное изображение
      if (overlay) {
        mainImage.addEventListener('click', function() {
          overlay.classList.remove('d-none');
          // Устанавливаем полноэкранное изображение на текущее
          const fsMain = document.getElementById('fsMainImage');
          fsMain.src = mainImage.src;
        });
        // Закрыть полноэкранный режим
        fsCloseBtn.addEventListener('click', function() {
          overlay.classList.add('d-none');
        });
        // Навигация в полноэкранном режиме
        fsPrevBtn.addEventListener('click', function() { showImage(currentIndex - 1); });
        fsNextBtn.addEventListener('click', function() { showImage(currentIndex + 1); });
        // Миниатюры в полноэкранном режиме
        fsThumbnails.forEach(function(thumb, index) {
          thumb.addEventListener('click', function() { showImage(index); });
        });
        // Закрытие по клику вне изображения
        overlay.addEventListener('click', function(event) {
          if (event.target === overlay) {
            overlay.classList.add('d-none');
          }
        });
      }
    });
  </script>
{% endblock %}