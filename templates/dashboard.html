{% extends "base.html" %}
{% block title %}Дашборд{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary fw-bold fs-4">Дашборд</h2>
  </div>
  <!-- Форма фильтра по дате: начало и конец периода -->
  <form id="dateFilterForm" hx-get="{{ url_for('dashboard') }}" hx-target="#dashboard-content" hx-push-url="true" class="row g-2 mb-4">
    <!-- Периодовой селектор: позволяет быстро выбрать отрезок времени -->
    <div class="col-auto">
      <label for="period" class="form-label mb-0">Период</label>
      <select id="period" name="period" class="form-select">
        <option value="" {% if not period %}selected{% endif %}>–</option>
        <option value="1d" {% if period == '1d' %}selected{% endif %}>1 день</option>
        <option value="week" {% if period == 'week' %}selected{% endif %}>Неделя</option>
        <option value="month" {% if period == 'month' %}selected{% endif %}>Месяц</option>
        <option value="year" {% if period == 'year' %}selected{% endif %}>Год</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="start" class="form-label mb-0">Начало</label>
      <!-- При нажатии на поле открывается календарь -->
      <input type="date" id="start" name="start" class="form-control" onclick="this.showPicker()" value="{{ start_date.isoformat() }}">
    </div>
    <div class="col-auto">
      <label for="end" class="form-label mb-0">Конец</label>
      <input type="date" id="end" name="end" class="form-control" onclick="this.showPicker()" value="{{ end_date.isoformat() }}">
    </div>
    <div class="col-auto align-self-end">
      <button type="submit" class="btn btn-primary">Применить</button>
    </div>
  </form>

  <div id="dashboard-content">
    {% include 'dashboard_content.html' %}
  </div>

  <!-- Скрипт для быстрого выбора периода -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var periodSelect = document.getElementById('period');
      if (periodSelect) {
        periodSelect.addEventListener('change', function () {
          var val = this.value;
          if (!val) {
            return;
          }
          var today = new Date();
          var startDate = new Date(today);
          // Вычисляем начальную дату исходя из выбранного периода
          if (val === '1d') {
            startDate = new Date(today);
          } else if (val === 'week') {
            startDate.setDate(today.getDate() - 6);
          } else if (val === 'month') {
            startDate.setDate(today.getDate() - 29);
          } else if (val === 'year') {
            startDate.setDate(today.getDate() - 364);
          }
          // Форматируем даты YYYY‑MM‑DD
          function fmt(d) {
            return d.toISOString().split('T')[0];
          }
          document.getElementById('start').value = fmt(startDate);
          document.getElementById('end').value = fmt(today);
          // Отправляем форму для применения фильтра; HX‑GET will intercept
          document.getElementById('dateFilterForm').submit();
        });
      }
    });
  </script>
{% endblock %}