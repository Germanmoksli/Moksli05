{% extends "base.html" %}
{% block title %}Гости{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    {# Добавляем счётчик гостей: показываем общее количество гостей рядом с заголовком #}
    <h2 class="text-primary fw-bold fs-4 mb-0">Гости
      {% if guests is defined %}
        <small class="text-muted">({{ guests | length }})</small>
      {% endif %}
    </h2>
    <div class="d-flex gap-2">
      {# Форма поиска гостя: поле ввода с подсказкой и кнопкой-иконкой внутри input-group #}
      <form class="d-flex" method="get" action="{{ url_for('list_guests') }}">
        <div class="input-group input-group-sm">
          <input class="form-control" type="search" name="search" placeholder="Поиск гостя" value="{{ search_query or '' }}" list="guest-search-hints">
          <button class="btn btn-outline-primary" type="submit" aria-label="Поиск">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </form>
      <a href="{{ url_for('add_guest') }}" class="btn btn-primary btn-sm">Добавить гостя</a>
    </div>
  </div>
  {% if guests %}
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ФИО</th>
          <th>Телефон</th>
          <th>Кол-во бронирований</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for guest in guests %}
          <tr>
            <td>
              <a href="{{ url_for('view_guest', guest_id=guest['id']) }}" class="text-decoration-none">
                {{ guest['name'] }}
              </a>
            </td>
            <td>{{ guest['phone'] | format_phone }}</td>
            <td>{{ guest['booking_count'] or 0 }}</td>
            <td class="d-flex gap-2">
              <!-- Кнопка добавления/удаления из чёрного списка -->
              {% if guest.blacklisted %}
                <form method="post" action="{{ url_for('remove_guest_from_blacklist', guest_id=guest['id']) }}" onsubmit="return confirm('Удалить гостя из чёрного списка?');">
                  <button type="submit" class="btn btn-sm btn-primary">Убрать из ЧС</button>
                </form>
              {% else %}
                <form method="post" action="{{ url_for('add_guest_to_blacklist', guest_id=guest['id']) }}" onsubmit="return promptBlacklistReason(this);">
                  <button type="submit" class="btn btn-sm btn-outline-danger">В чёрный список</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Нет гостей в системе.</p>
  {% endif %}
  <script>
    // Prompt the user for a blacklist reason and attach it to the form as a hidden field.
    function promptBlacklistReason(form) {
      var reason = prompt('Введите причину, по которой гость заносится в чёрный список:');
      if (reason === null) {
        // User pressed cancel; do not submit the form
        return false;
      }
      // Trim whitespace
      reason = reason.trim();
      if (!reason) {
        alert('Причина обязательна. Введите текст и попробуйте снова.');
        return false;
      }
      // Create a hidden input to send the reason to the server
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'reason';
      input.value = reason;
      form.appendChild(input);
      return true;
    }

    // Показывать подсказки поиска только после ввода символов. Убираем атрибут list при фокусе и
    // восстанавливаем его, когда в поле появится текст. Это предотвращает показ выпадающего списка
    // сразу при клике, пока пользователь ещё ничего не ввёл.
    document.addEventListener('DOMContentLoaded', function () {
      var searchInput = document.querySelector('input[name="search"]');
      if (searchInput && searchInput.hasAttribute('list')) {
        // Сохраняем id привязанного datalist и убираем list по умолчанию
        var listId = searchInput.getAttribute('list');
        searchInput.removeAttribute('list');
        searchInput.addEventListener('input', function () {
          if (searchInput.value.trim().length > 0) {
            searchInput.setAttribute('list', listId);
          } else {
            searchInput.removeAttribute('list');
          }
        });
      }
    });
  </script>
{% endblock %}