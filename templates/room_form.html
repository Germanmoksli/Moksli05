{% extends "base.html" %}

{% block title %}Добавить квартиру{% endblock %}

{#
  Многошаговая форма создания нового объекта. Каждый шаг соответствует
  отдельному пункту на отправленных скриншотах. Пользователь заполняет
  информацию шаг за шагом, нажимая кнопку «Далее» для перехода на
  следующий раздел или «Назад» для возврата. На последнем шаге есть
  кнопки для предпросмотра, публикации или сохранения в черновик.
  Содержимое каждой секции обёрнуто в элемент с классом .step. Все
  элементы .step кроме первого скрываются с помощью класса d-none.
  Навигация между шагами реализована внизу шаблона через небольшой
  скрипт JavaScript, который показывает или скрывает нужный блок.

  Некоторые поля не используются в текущей реализации backend, но
  предусмотрены для расширяемости (например, min/max аренды, список
  удобств). Вы можете адаптировать обработку этих полей в app.py по
  необходимости.  Карта Leaflet загружается только на шаге 8.
#}

{% block content %}
<div class="mx-auto" style="max-width: 900px;">
  <h2 class="text-center text-primary fw-bold fs-4">Добавить объект</h2>
  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    <!-- Шаг 1. Основная информация -->
    <div class="step" id="step1">
      <h3 class="fw-bold mb-3">1. Основная информация</h3>
      <div class="mb-3">
        <label for="room_number" class="form-label">Заголовок объявления</label>
        <input type="text" class="form-control" id="room_number" name="room_number" placeholder="Например: 1‑комнатная квартира в центре Алматы" required>
        <div class="invalid-feedback">Введите заголовок объявления.</div>
      </div>
      <div class="mb-3">
        <label for="housing_type" class="form-label">Тип жилья</label>
        <select id="housing_type" name="housing_type" class="form-select" required>
          <option value="" selected>Выберите тип жилья</option>
          <option value="flat">Квартира</option>
          <option value="studio">Студия</option>
          <option value="house">Дом</option>
          <option value="apartment">Апартаменты</option>
          <option value="room">Комната</option>
        </select>
        <div class="invalid-feedback">Выберите тип жилья.</div>
      </div>
      <div class="mb-3">
        <label class="form-label">Количество комнат</label>
        {#
          Группа вариантов выбора количества комнат. Используем радиокнопки с классом
          ``btn-check`` и соответствующими метками, стилизованными под квадратные
          чекбоксы. Пользователь может выбрать только один вариант, но внешний
          вид напоминает набор чекбоксов с цифрами 1; 2; 3; 4; 5+. Чтобы настроить
          размер и форму элементов, ниже добавлены CSS‑стили для класса
          .room-option.
        #}
        <div class="btn-group" role="group" aria-label="Количество комнат">
          <input type="radio" class="btn-check" name="num_rooms" id="rooms1" value="1" autocomplete="off" required>
          <label class="btn btn-outline-secondary room-option" for="rooms1">1</label>

          <input type="radio" class="btn-check" name="num_rooms" id="rooms2" value="2" autocomplete="off">
          <label class="btn btn-outline-secondary room-option" for="rooms2">2</label>

          <input type="radio" class="btn-check" name="num_rooms" id="rooms3" value="3" autocomplete="off">
          <label class="btn btn-outline-secondary room-option" for="rooms3">3</label>

          <input type="radio" class="btn-check" name="num_rooms" id="rooms4" value="4" autocomplete="off">
          <label class="btn btn-outline-secondary room-option" for="rooms4">4</label>

          <input type="radio" class="btn-check" name="num_rooms" id="rooms5" value="5" autocomplete="off">
          <label class="btn btn-outline-secondary room-option" for="rooms5">5+</label>
        </div>
        <div class="invalid-feedback">Выберите количество комнат.</div>
      </div>
      <div class="mb-3">
        <label for="area_total" class="form-label">Площадь (м²)</label>
        <input type="number" step="0.1" class="form-control" id="area_total" name="area_total" min="0" placeholder="Общая площадь" required>
        <div class="invalid-feedback">Введите общую площадь.</div>
      </div>
      <div class="mb-3 d-flex gap-2">
        <div class="flex-grow-1">
          <label for="floor" class="form-label">Этаж</label>
          <input type="number" class="form-control" id="floor" name="floor" min="0" required>
        </div>
        <div class="flex-grow-1">
          <label for="floors_total" class="form-label">Всего этажей в доме</label>
          <input type="number" class="form-control" id="floors_total" name="floors_total" min="0" required>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <label for="country_input" class="form-label">Страна</label>
        <input type="text" class="form-control" id="country_input" autocomplete="off" placeholder="Начните вводить страну" required>
        <div class="invalid-feedback">Введите страну.</div>
      </div>
      <div class="mb-3 position-relative">
        <label for="city_input" class="form-label">Город</label>
        <input type="text" class="form-control" id="city_input" autocomplete="off" placeholder="Начните вводить город" required>
        <div class="invalid-feedback">Введите город.</div>
      </div>
      <div class="mb-3 position-relative">
        <label for="street_input" class="form-label">Улица</label>
        <input type="text" class="form-control" id="street_input" autocomplete="off" placeholder="Начните вводить улицу" required>
        <div class="invalid-feedback">Введите улицу.</div>
      </div>
      <div class="mb-3 position-relative">
        <label for="house_input" class="form-label">Номер дома</label>
        <input type="text" class="form-control" id="house_input" autocomplete="off" placeholder="Номер дома" required>
        <div class="invalid-feedback">Введите номер дома.</div>
      </div>
      <!-- Карта для отображения местоположения -->
      <div class="mb-3">
        <label class="form-label">Карта</label>
        <div id="mapid-step1" style="height: 300px;"></div>
      </div>
      <!-- скрытые поля для компонентов адреса и координат -->
      <input type="hidden" id="country" name="country" value="">
      <input type="hidden" id="city" name="city" value="">
      <input type="hidden" id="street" name="street" value="">
      <input type="hidden" id="house_number" name="house_number" value="">
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">
      <div class="mb-3">
        <label for="description" class="form-label">Описание</label>
        <textarea id="description" name="description" class="form-control" rows="4" placeholder="Подробное описание квартиры, особенности и условия" required></textarea>
        <div class="invalid-feedback">Введите описание.</div>
      </div>
      <div class="text-end">
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 2. Фотографии -->
    <div class="step d-none" id="step2">
      <h3 class="fw-bold mb-3">2. Фотографии</h3>
      <div class="mb-3">
        <label for="photos" class="form-label">Загрузить фото</label>
        <input type="file" class="form-control" id="photos" name="photos" accept="image/*" multiple>
        <div class="form-text">До 10–15 фото высокого качества</div>
      </div>
      <div class="mb-3">
        <label for="main_photo_index" class="form-label">Главное фото (номер из загруженных)</label>
        <select class="form-select" id="main_photo_index" name="main_photo_index">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
        </select>
        <div class="form-text">Одно из загруженных фото будет отображаться первым</div>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 3. Стоимость и условия -->
    <div class="step d-none" id="step3">
      <h3 class="fw-bold mb-3">3. Стоимость и условия</h3>
      <div class="mb-3">
        <label for="price_per_night" class="form-label">Цена за сутки (₸)</label>
        <input type="number" step="0.01" class="form-control" id="price_per_night" name="price_per_night" required>
        <div class="invalid-feedback">Введите цену за сутки.</div>
      </div>
      <div class="mb-3">
        <label for="discount" class="form-label">Скидки</label>
        <input type="text" class="form-control" id="discount" name="discount" placeholder="Например: при брони от 3 суток — 5%">
      </div>
      <div class="mb-3">
        <label for="deposit" class="form-label">Залог (если есть)</label>
        <input type="number" step="0.01" class="form-control" id="deposit" name="deposit" placeholder="Сумма залога или 0">
      </div>
      <div class="mb-3 d-flex gap-2">
        <div class="flex-grow-1">
          <label for="min_rent_days" class="form-label">Минимальный срок аренды</label>
          <select id="min_rent_days" name="min_rent_days" class="form-select" required>
            <option value="1">1 сутки</option>
            <option value="2">2 суток</option>
            <option value="3">3 суток</option>
            <option value="4">4 суток</option>
            <option value="5">5 суток</option>
            <option value="6">6 суток</option>
            <option value="7">7 суток</option>
          </select>
        </div>
        <div class="flex-grow-1">
          <label for="max_rent_days" class="form-label">Максимальный срок аренды</label>
          <select id="max_rent_days" name="max_rent_days" class="form-select">
            <option value="">Опционально</option>
            <option value="7">7 суток</option>
            <option value="14">14 суток</option>
            <option value="30">30 суток</option>
            <option value="60">60 суток</option>
            <option value="90">90 суток</option>
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label for="extra_charges" class="form-label">Дополнительные расходы</label>
        <textarea id="extra_charges" name="extra_charges" class="form-control" rows="3" placeholder="Например, уборка, парковка и т. п."></textarea>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 4. Вместимость и правила -->
    <div class="step d-none" id="step4">
      <h3 class="fw-bold mb-3">4. Вместимость и правила</h3>
      <div class="mb-3">
        <label for="max_guests" class="form-label">Максимум гостей</label>
        <input type="number" class="form-control" id="max_guests" name="max_guests" min="1" placeholder="Например: до 3 человек" required>
        <div class="invalid-feedback">Укажите количество гостей.</div>
      </div>
      <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" id="allow_children" name="allow_children">
        <label class="form-check-label" for="allow_children">Разрешено с детьми</label>
      </div>
      <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" id="allow_pets" name="allow_pets">
        <label class="form-check-label" for="allow_pets">Разрешено с животными</label>
      </div>
      <div class="mb-3">
        <label for="smoking_policy" class="form-label">Курение</label>
        <select id="smoking_policy" name="smoking_policy" class="form-select" required>
          <option value="allowed">Разрешено</option>
          <option value="forbidden">Запрещено</option>
          <option value="balcony">Только на балконе</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="parties_policy" class="form-label">Вечеринки</label>
        <select id="parties_policy" name="parties_policy" class="form-select" required>
          <option value="allowed">Разрешены</option>
          <option value="not_allowed">Нет</option>
        </select>
      </div>
      <div class="mb-3 d-flex gap-2">
        <div class="flex-grow-1">
          <label for="checkin_time" class="form-label">Чек-ин</label>
          <input type="time" class="form-control" id="checkin_time" name="checkin_time" required>
        </div>
        <div class="flex-grow-1">
          <label for="checkout_time" class="form-label">Чек-аут</label>
          <input type="time" class="form-control" id="checkout_time" name="checkout_time" required>
        </div>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 5. Удобства -->
    <div class="step d-none" id="step5">
      <h3 class="fw-bold mb-3">5. Удобства</h3>
      <div class="mb-3">
        <label for="amenities" class="form-label">Список удобств</label>
        <select id="amenities" name="amenities" class="form-select" multiple size="7">
          <option value="wifi">Wi‑Fi</option>
          <option value="ac">Кондиционер</option>
          <option value="tv">Телевизор</option>
          <option value="washing_machine">Стиральная машина</option>
          <option value="kitchen">Кухня</option>
          <option value="elevator">Лифт</option>
          <option value="parking">Парковка</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="features" class="form-label">Особенности жилья</label>
        <select id="features" name="features" class="form-select" multiple size="6">
          <option value="panoramic_view">Панорамный вид</option>
          <option value="balcony">Балкон</option>
          <option value="jacuzzi">Джакузи</option>
          <option value="cozy_interior">Уютный интерьер</option>
          <option value="fireplace">Камин</option>
          <option value="pool">Бассейн</option>
        </select>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 6. Контакты владельца -->
    <div class="step d-none" id="step6">
      <h3 class="fw-bold mb-3">6. Контакты владельца</h3>
      <div class="mb-3">
        <label for="owner_name" class="form-label">Имя владельца</label>
        <input type="text" class="form-control" id="owner_name" name="owner_name" required>
        <div class="invalid-feedback">Введите имя владельца.</div>
      </div>
      <div class="mb-3">
        <label for="owner_phone" class="form-label">Номер телефона</label>
        <input type="tel" class="form-control" id="owner_phone" name="owner_phone" placeholder="Для связи с гостями" required>
        <div class="invalid-feedback">Введите номер телефона.</div>
      </div>
      <div class="mb-3">
        <label for="owner_messenger" class="form-label">WhatsApp / Telegram</label>
        <input type="text" class="form-control" id="owner_messenger" name="owner_messenger" placeholder="Ссылка или номер">
      </div>
      <div class="mb-3">
        <label for="owner_email" class="form-label">Email (опционально)</label>
        <input type="email" class="form-control" id="owner_email" name="owner_email" placeholder="Если используется">
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 7. Доступность и бронирование -->
    <div class="step d-none" id="step7">
      <h3 class="fw-bold mb-3">7. Доступность и бронирование</h3>
      <div class="mb-3">
        <label for="unavailable_dates" class="form-label">Календарь доступности</label>
        <textarea id="unavailable_dates" name="unavailable_dates" class="form-control" rows="3" placeholder="Отмечаются занятые и свободные даты (формат: 2025-10-10,2025-10-11,...)"></textarea>
        <div class="form-text">Через запятую укажите даты, когда жильё занято.</div>
      </div>
      <div class="mb-3">
        <label for="min_notice_days" class="form-label">Минимальный срок до бронирования</label>
        <input type="number" class="form-control" id="min_notice_days" name="min_notice_days" placeholder="Например: бронирование минимум за 1 день" required>
      </div>
      <div class="mb-3">
        <label for="booking_method" class="form-label">Способ бронирования</label>
        <select id="booking_method" name="booking_method" class="form-select" required>
          <option value="auto">Автоматическое подтверждение</option>
          <option value="manual">Только после одобрения владельца</option>
        </select>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="button" class="btn btn-primary next-btn">Далее</button>
      </div>
    </div>
    <!-- Шаг 8. Предпросмотр и публикация -->
    <div class="step d-none" id="step8">
      <h3 class="fw-bold mb-3">8. Предпросмотр и публикация</h3>
      <p>Вы можете сохранить объявление как черновик, опубликовать его или предварительно просмотреть, как оно будет выглядеть для гостей.</p>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-secondary prev-btn">Назад</button>
        <button type="submit" name="action" value="preview" class="btn btn-info">Предпросмотр</button>
        <button type="submit" name="action" value="publish" class="btn btn-success">Опубликовать</button>
        <button type="submit" name="action" value="draft" class="btn btn-outline-secondary">Черновик</button>
      </div>
    </div>
    <!-- скрытые поля для совместимости с существующей моделью -->
    <!-- Площадь кухни, если не указана, по умолчанию 0 -->
    <input type="hidden" name="area_kitchen" value="0">
    <!-- Состояние квартиры: автоматически ставим без ремонта -->
    <input type="hidden" name="condition" value="good">
    <!-- Кухня студия: по умолчанию нет -->
    <input type="hidden" name="kitchen_studio" value="no">
  </form>
</div>


{# Подключаем Google Maps JavaScript API вместо Leaflet.  API‑ключ передаётся
   из Flask через переменную google_maps_api_key.  Мы загружаем библиотеку
   Places для автодополнения и вызываем функцию initMap как callback. #}
{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>
{% endif %}

<script>
// Многошаговая навигация и ограничения на загрузку фотографий
document.addEventListener('DOMContentLoaded', function() {
  var steps = document.querySelectorAll('.step');
  var currentStep = 0;
  function showStep(index) {
    steps.forEach(function(step, idx) {
      if (idx === index) {
        step.classList.remove('d-none');
      } else {
        step.classList.add('d-none');
      }
    });
    currentStep = index;
  }
  document.querySelectorAll('.next-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (currentStep < steps.length - 1) {
        showStep(currentStep + 1);
      }
    });
  });
  document.querySelectorAll('.prev-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (currentStep > 0) {
        showStep(currentStep - 1);
      }
    });
  });
  showStep(0);
  var photosInput = document.getElementById('photos');
  if (photosInput) {
    photosInput.addEventListener('change', function() {
      if (this.files.length > 20) {
        alert('Вы можете загрузить не более 20 фотографий.');
        this.value = '';
      }
    });
  }
});

// Инициализация Google Maps и автодополнений адреса для первого шага
function initMap() {
  var mapContainer = document.getElementById('mapid-step1');
  if (!mapContainer) return;
  // Начальная точка: Алма‑Ата (можете изменить на нужную)
  var defaultLatLng = { lat: 43.238949, lng: 76.889709 };
  var map = new google.maps.Map(mapContainer, { center: defaultLatLng, zoom: 12 });
  var marker = new google.maps.Marker({ map: map, position: defaultLatLng, draggable: true });
  // Обновляем скрытые поля при перемещении маркера
  function updateLatLng(lat, lon) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;
  }
  updateLatLng(defaultLatLng.lat, defaultLatLng.lng);
  marker.addListener('dragend', function(event) {
    updateLatLng(event.latLng.lat(), event.latLng.lng());
  });
  map.addListener('click', function(e) {
    marker.setPosition(e.latLng);
    updateLatLng(e.latLng.lat(), e.latLng.lng());
  });
  // Настройка автодополнения для каждого поля. Используем Google Places.
  function setupAutocomplete(inputId, types) {
    var inputEl = document.getElementById(inputId);
    if (!inputEl) return null;
    var options = {};
    if (types) {
      options.types = types;
    }
    var autocomplete = new google.maps.places.Autocomplete(inputEl, options);
    autocomplete.addListener('place_changed', function() {
      var place = autocomplete.getPlace();
      if (!place || !place.geometry) return;
      var components = place.address_components || [];
      // Обновляем скрытые поля в зависимости от типа поля
      var countryVal = document.getElementById('country').value;
      var cityVal = document.getElementById('city').value;
      var streetVal = document.getElementById('street').value;
      var houseVal = document.getElementById('house_number').value;
      components.forEach(function(comp) {
        if (comp.types.includes('country')) {
          countryVal = comp.long_name;
        }
        if (comp.types.includes('locality') || comp.types.includes('administrative_area_level_1')) {
          cityVal = comp.long_name;
        }
        if (comp.types.includes('route')) {
          streetVal = comp.long_name;
        }
        if (comp.types.includes('street_number')) {
          houseVal = comp.long_name;
        }
      });
      document.getElementById('country').value = countryVal;
      document.getElementById('city').value = cityVal;
      document.getElementById('street').value = streetVal;
      document.getElementById('house_number').value = houseVal;
      // Отображаем заполненные значения в полях ввода, если они существуют
      if (document.getElementById('country_input') && countryVal && inputId !== 'country_input') {
        document.getElementById('country_input').value = countryVal;
      }
      if (document.getElementById('city_input') && cityVal && inputId !== 'city_input') {
        document.getElementById('city_input').value = cityVal;
      }
      if (document.getElementById('street_input') && streetVal && inputId !== 'street_input') {
        document.getElementById('street_input').value = streetVal;
      }
      if (document.getElementById('house_input') && houseVal && inputId !== 'house_input') {
        document.getElementById('house_input').value = houseVal;
      }
      // Центрируем карту и маркер на выбранный адрес
      if (place.geometry && place.geometry.location) {
        var lat = place.geometry.location.lat();
        var lng = place.geometry.location.lng();
        map.setCenter({ lat: lat, lng: lng });
        map.setZoom(16);
        marker.setPosition({ lat: lat, lng: lng });
        updateLatLng(lat, lng);
      }
    });
    return autocomplete;
  }
  // Настраиваем автодополнение для каждого поля: страна, город, улица, дом
  setupAutocomplete('country_input', ['(regions)']);
  setupAutocomplete('city_input', ['(cities)']);
  setupAutocomplete('street_input', ['address']);
  setupAutocomplete('house_input', ['address']);
}
</script>

<script>
// Валидация форм Bootstrap
(function () {
  'use strict'
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
})();
</script>
{% endblock %}

{#
  Дополнительные стили для элементов формы.
  Объявляем после всех блоков, чтобы они могли переопределять
  стандартные стили Bootstrap при необходимости.
#}
<style>
  /* Стилизуем варианты выбора количества комнат как квадратные кнопки */
  .room-option {
    width: 48px;
    height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-weight: 600;
    font-size: 1rem;
    padding: 0;
  }
  /* Добавляем небольшой отступ между элементами, чтобы они не слипались */
  .btn-group .room-option + input + .room-option {
    margin-left: 0.5rem;
  }
</style>