{% extends "base.html" %}
{% block title %}Добавить квартиру{% endblock %}
{% block content %}
  <div class="mx-auto" style="max-width: 700px;">
    <h2 class="text-center text-primary fw-bold fs-4">Добавить объект</h2>
    <!-- Используем multipart/form-data для загрузки фотографий -->
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
      <!-- Название объекта (ранее room_number) -->
      <div class="mb-3">
        <label for="room_number" class="form-label">Название объекта</label>
        <input type="text" class="form-control" id="room_number" name="room_number" required>
        <div class="invalid-feedback">Введите название объекта.</div>
      </div>
      <!-- Количество комнат -->
      <div class="mb-3">
        <label for="num_rooms" class="form-label">Количество комнат</label>
        <input type="number" class="form-control" id="num_rooms" name="num_rooms" min="0" required>
        <div class="invalid-feedback">Введите количество комнат.</div>
      </div>
      <!-- Этаж и общее количество этажей -->
      <div class="mb-3">
        <label class="form-label">Этаж</label>
        <div class="d-flex gap-2">
          <input type="number" class="form-control" id="floor" name="floor" min="0" placeholder="Этаж" required>
          <span class="align-self-center">из</span>
          <input type="number" class="form-control" id="floors_total" name="floors_total" min="0" placeholder="Всего этажей" required>
        </div>
        <div class="invalid-feedback">Введите этаж и общее количество этажей.</div>
      </div>
      <!-- Площадь квартиры и площадь кухни -->
      <div class="mb-3">
        <label class="form-label">Площадь (м²)</label>
        <div class="d-flex gap-2">
          <input type="number" step="0.1" class="form-control" id="area_total" name="area_total" min="0" placeholder="Общая" required>
          <span class="align-self-center">из них кухня</span>
          <input type="number" step="0.1" class="form-control" id="area_kitchen" name="area_kitchen" min="0" placeholder="Кухня" required>
        </div>
        <div class="invalid-feedback">Введите общую площадь и площадь кухни.</div>
      </div>
      <!-- Состояние квартиры -->
      <div class="mb-3">
        <label for="condition" class="form-label">Состояние квартиры</label>
        <select id="condition" name="condition" class="form-select" required>
          <option value="" selected>Выберите состояние</option>
          <option value="fresh">Свежий ремонт, новая мебель</option>
          <option value="good">Не свежий, но аккуратный ремонт</option>
          <option value="none">Без ремонта</option>
        </select>
        <div class="invalid-feedback">Выберите состояние.</div>
      </div>
      <!-- Кухня студия -->
      <div class="mb-3">
        <label class="form-label">Кухня студия</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="kitchen_studio" id="kitchen_yes" value="yes" required>
          <label class="form-check-label" for="kitchen_yes">Да</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="kitchen_studio" id="kitchen_no" value="no">
          <label class="form-check-label" for="kitchen_no">Нет</label>
        </div>
        <div class="invalid-feedback">Укажите, является ли кухня студией.</div>
      </div>
      <!-- Адрес с подсказками -->
      <div class="mb-3 position-relative">
        <label for="address" class="form-label">Расположение (введите страну, город, улицу, дом)</label>
        <input type="text" class="form-control" id="address" name="address" autocomplete="off" placeholder="Например: Казахстан, Алматы, Абая 10" required>
        <ul id="suggestions-list" class="list-group position-absolute w-100" style="z-index: 1000;"></ul>
        <div class="invalid-feedback">Введите адрес.</div>
      </div>
      <!-- Скрытые поля для частей адреса и координат -->
      <input type="hidden" id="country" name="country">
      <input type="hidden" id="city" name="city">
      <input type="hidden" id="street" name="street">
      <input type="hidden" id="house_number" name="house_number">
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">
      <!-- Карта для выбора координат -->
      <div class="mb-3">
        <label class="form-label">Выберите расположение на карте</label>
        <div id="mapid" style="height: 300px;"></div>
      </div>
      <!-- Фотографии -->
      <div class="mb-3">
        <label for="photos" class="form-label">Фотографии квартиры (до 20 изображений)</label>
        <input type="file" class="form-control" id="photos" name="photos" accept="image/*" multiple>
        <div class="form-text">Можно загрузить до 20 фотографий. Выберите несколько файлов.</div>
      </div>
      <!-- Цена за сутки аренды -->
      <div class="mb-3">
        <label for="price_per_night" class="form-label">Цена за 1 сутки аренды</label>
        <input type="number" step="0.01" class="form-control" id="price_per_night" name="price_per_night" required>
        <div class="invalid-feedback">Укажите цену за сутки.</div>
      </div>
      <!-- Жилой комплекс (опционально) -->
      <div class="mb-3">
        <label for="residential_complex" class="form-label">Жилой комплекс</label>
        <select class="form-select" id="residential_complex" name="residential_complex">
          <option value="" selected>Не указан</option>
          <option value="Auezov City">ЖК Auezov City</option>
          <option value="Шахристан">ЖК Шахристан</option>
          <option value="Lake Town">ЖК Lake Town</option>
        </select>
        <div class="form-text">Выберите жилой комплекс, если применимо.</div>
      </div>
      <!-- Ссылка на объявление (опционально) -->
      <div class="mb-3">
        <label for="listing_url" class="form-label">Ссылка на объявление (URL)</label>
        <input type="url" class="form-control" id="listing_url" name="listing_url">
        <div class="form-text">Опционально: укажите ссылку на размещение объекта на стороннем сайте.</div>
      </div>
      <!-- Кнопки сохранения и отмены -->
      <div class="text-center">
        <button type="submit" class="btn btn-primary me-2">Сохранить</button>
        <a href="{{ url_for('list_rooms') }}" class="btn btn-soft-danger">Отмена</a>
      </div>
    </form>
  </div>
  <!-- Подключаем Leaflet для карты -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="" crossorigin=""></script>
  <script>
  // Инициализация карты и работа с адресными подсказками
  document.addEventListener('DOMContentLoaded', function() {
    // Настройка карты
    var map = L.map('mapid').setView([43.238949, 76.889709], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    var marker;
    map.on('click', function(e) {
      var lat = e.latlng.lat;
      var lon = e.latlng.lng;
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;
      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }
    });
    // Настройка подсказок при вводе адреса
    var addressInput = document.getElementById('address');
    var suggestionsList = document.getElementById('suggestions-list');
    addressInput.addEventListener('input', function() {
      var query = addressInput.value.trim();
      if (query.length < 3) {
        suggestionsList.innerHTML = '';
        return;
      }
      fetch('{{ url_for('address_suggestions') }}?q=' + encodeURIComponent(query))
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
          suggestionsList.innerHTML = '';
          data.forEach(function(item) {
            var li = document.createElement('li');
            li.classList.add('list-group-item', 'list-group-item-action');
            li.textContent = item.display_name;
            li.dataset.lat = item.lat;
            li.dataset.lon = item.lon;
            li.dataset.country = item.country || '';
            li.dataset.city = item.city || '';
            li.dataset.street = item.street || '';
            li.dataset.house_number = item.house_number || '';
            suggestionsList.appendChild(li);
          });
        });
    });
    suggestionsList.addEventListener('click', function(e) {
      if (e.target && e.target.nodeName === 'LI') {
        addressInput.value = e.target.textContent;
        document.getElementById('latitude').value = e.target.dataset.lat;
        document.getElementById('longitude').value = e.target.dataset.lon;
        document.getElementById('country').value = e.target.dataset.country;
        document.getElementById('city').value = e.target.dataset.city;
        document.getElementById('street').value = e.target.dataset.street;
        document.getElementById('house_number').value = e.target.dataset.house_number;
        suggestionsList.innerHTML = '';
        // Переместить маркер на выбранную точку
        var latf = parseFloat(e.target.dataset.lat);
        var lonf = parseFloat(e.target.dataset.lon);
        map.setView([latf, lonf], 16);
        if (marker) {
          marker.setLatLng([latf, lonf]);
        } else {
          marker = L.marker([latf, lonf]).addTo(map);
        }
      }
    });
  });
  </script>
  <script>
    // Ограничение количества загружаемых фотографий
    document.addEventListener('DOMContentLoaded', function() {
      var photosInput = document.getElementById('photos');
      if (photosInput) {
        photosInput.addEventListener('change', function() {
          if (this.files.length > 20) {
            alert('Вы можете загрузить не более 20 фотографий.');
            this.value = '';
          }
        });
      }
    });
  </script>
  <script>
    // Bootstrap валидация форм: добавляет класс was-validated и предотвращает отправку
    // формы при наличии недопустимых полей. Этот скрипт аналогичен стандартному
    // примеру из документации Bootstrap. Он работает для всех форм с классом
    // .needs-validation на странице.
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation');
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
    })();
  </script>
{% endblock %}