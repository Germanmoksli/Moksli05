{#
  This template renders the dynamic portion of the dashboard (KPIs, pick‑up
  chart and per‑room statistics).  It is intended to be included by
  ``dashboard.html`` and returned directly when serving HTMX requests.  See
  ``app.py`` for the logic that distinguishes between full page and partial
  responses.
#}

<!-- Основные KPI -->
<div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-1">Занятость</h6>
        <small class="text-muted">{{ sold_nights }}/{{ nights_available }}</small>
      </div>
      <h3 class="fw-bold">{{ occupancy | round(1) }}%</h3>
    </div>
  </div>
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">ADR</h6>
      <h3 class="fw-bold">{{ adr | currency }}</h3>
    </div>
  </div>
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">RevPAR</h6>
      <h3 class="fw-bold">{{ revpar | currency }}</h3>
    </div>
  </div>
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">Выручка</h6>
      <h3 class="fw-bold">{{ total_revenue | currency }}</h3>
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">Заезды ({{ start_date.strftime('%d.%m') }})</h6>
      <h3 class="fw-bold">{{ check_in_count }}</h3>
    </div>
  </div>
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">Выезды ({{ start_date.strftime('%d.%m') }})</h6>
      <h3 class="fw-bold">{{ check_out_count }}</h3>
    </div>
  </div>
  <div class="col">
    <div class="p-3 bg-white border rounded">
      <h6 class="mb-1">Депозиты</h6>
      <ul class="list-unstyled mb-0 small">
        <li><span class="text-muted">Оплачено:</span> {{ deposit_counts.get('paid', 0) }}</li>
        <li><span class="text-muted">Удержано:</span> {{ deposit_counts.get('withheld', 0) }}</li>
        <li><span class="text-muted">Возвращено:</span> {{ deposit_counts.get('returned', 0) }}</li>
      </ul>
    </div>
  </div>
</div>

<h5 class="mb-2">Пикап (14 дней)</h5>
<div class="bg-white border rounded p-3 mb-4">
  <canvas id="pickupChart" height="120"></canvas>
</div>

<!-- Подключаем Chart.js для построения графиков -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var ctx = document.getElementById('pickupChart').getContext('2d');
    // Destroy any existing chart on this canvas to avoid overlaying charts when
    // re‑rendering via HTMX.
    if (window._pickupChartInstance) {
      window._pickupChartInstance.destroy();
    }
    window._pickupChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ pickup_dates|tojson }},
        datasets: [
          {
            label: 'Занятость (%)',
            data: {{ pickup_occ|tojson }},
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            yAxisID: 'y-occupancy',
            tension: 0.3
          },
          {
            label: 'Выручка',
            data: {{ pickup_revenue|tojson }},
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            yAxisID: 'y-revenue',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          'y-occupancy': {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            },
            title: {
              display: true,
              text: 'Занятость (%)'
            }
          },
          'y-revenue': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            grid: {
              drawOnChartArea: false
            },
            title: {
              display: true,
              text: 'Выручка (₸)'
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (context) {
                var label = context.dataset.label || '';
                if (context.dataset.yAxisID === 'y-occupancy') {
                  return label + ': ' + context.parsed.y + '%';
                } else {
                  return label + ': ' + new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KZT' }).format(context.parsed.y);
                }
              }
            }
          }
        }
      }
    });
  });
</script>

<!-- Перечень квартир и их показатели -->
<h5 class="mb-2 mt-4">Статистика по квартирам</h5>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-sm align-middle text-center">
    <thead class="table-light">
      <tr>
        <th scope="col">Квартира</th>
        <th scope="col">Проданные ночи</th>
        <th scope="col">Пустые ночи</th>
        <th scope="col">Занятость</th>
        <th scope="col">Доход</th>
        <th scope="col">ADR</th>
        <th scope="col">Бронирований</th>
        <th scope="col">Депозиты (опл./удерж./возв.)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in room_stats %}
      <tr>
        <td>{{ r.room_number }}</td>
        <td>{{ r.nights_sold }}</td>
        <td>{{ r.empty_nights }}</td>
        <td>{{ r.occupancy | round(1) }}%</td>
        <td>{{ r.revenue | currency }}</td>
        <td>{{ r.adr | currency }}</td>
        <td>{{ r.booking_count }}</td>
        <td>
          {{ r.deposit_counts.get('paid', 0) }} / {{ r.deposit_counts.get('withheld', 0) }} / {{ r.deposit_counts.get('returned', 0) }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>