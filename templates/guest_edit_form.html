{% extends "base.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç—è{% endblock %}
{% block content %}
  <div class="mx-auto" style="max-width: 720px;">
    <h2 class="text-primary fw-bold fs-4 mb-3 text-center">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç–µ</h2>
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
      <!-- Avatar at the top center; enlarge and overlay '–ß–°' if blacklisted -->
      {% set photo_url = guest['photo'] and url_for('static', filename='uploads/' + guest['photo']) or url_for('static', filename='default_avatar.png') %}
      <div class="text-center mb-3">
        <label for="photo" style="cursor: pointer;">
          <div class="position-relative d-inline-block">
            <img src="{{ photo_url }}" alt="–§–æ—Ç–æ –≥–æ—Å—Ç—è" class="rounded-circle" style="width: 128px; height: 128px; object-fit: cover;">
            {% if blacklisted %}
            <div class="position-absolute bottom-0 start-50 translate-middle-x px-2 py-1 bg-danger text-white small fw-bold" style="border-radius: 0.25rem;">
              –ß–°
            </div>
            {% endif %}
          </div>
        </label>
        <input type="file" id="photo" name="photo" accept="image/*" class="d-none">
      </div>
      <!-- Second row: Last name and First name (proportionally sized) -->
      <div class="d-flex justify-content-center mb-3 gap-3">
        <div class="flex-fill" style="max-width: 350px;">
          <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
          <input type="text" class="form-control" id="last_name" name="last_name" value="{{ last_name or '' }}" required>
        </div>
        <div class="flex-fill" style="max-width: 350px;">
          <label for="first_name" class="form-label">–ò–º—è</label>
          <input type="text" class="form-control" id="first_name" name="first_name" value="{{ first_name or '' }}" required>
        </div>
      </div>
      <!-- Third row: Patronymic and birth date (proportionally sized) -->
      <div class="d-flex justify-content-center mb-3 gap-3">
        <div class="flex-fill" style="max-width: 350px;">
          <label for="patronymic" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
          <input type="text" class="form-control" id="patronymic" name="patronymic" value="{{ patronymic or '' }}">
        </div>
        <div class="flex-fill" style="max-width: 350px;">
          <label for="birth_date" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" class="form-control" id="birth_date" name="birth_date" value="{{ guest['birth_date'] or '' }}">
        </div>
      </div>
      <!-- Phone row: label, country code selector and phone input combined to match comment width -->
      <div class="d-flex justify-content-center mb-3">
        <div class="flex-fill" style="max-width: 350px;">
          <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <div class="d-flex gap-2">
            <div style="flex: 0 0 auto; min-width: 100px; max-width: 180px;">
              <select id="country_code" name="country_code" class="form-select w-100">
                <!-- Country codes and corresponding masks; defaults to +7 (Kazakhstan) -->
                <option value="+7" data-mask="(XXX) XXX XX XX" data-length="10" data-flag="üá∞üáø" selected>üá∞üáø +7</option>
                <option value="+1" data-mask="(XXX) XXX-XXXX" data-length="10" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
                <option value="+44" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá¨üáß">üá¨üáß +44</option>
                <option value="+49" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá©üá™">üá©üá™ +49</option>
                <option value="+81" data-mask="(XXXX) XXX XXX" data-length="9" data-flag="üáØüáµ">üáØüáµ +81</option>
              </select>
            </div>
            <div style="flex: 1 1 70%;">
              <input type="tel" class="form-control" id="phone" name="phone" placeholder="(XXX) XXX XX XX" value="{{ guest['phone'] or '' }}" data-initial-digits="{{ phone_digits or '' }}" list="guest-phones">
            </div>
          </div>
        </div>
      </div>
      <!-- Warning for blacklisted phone numbers -->
      <div class="text-center mb-3">
        <div id="blacklist-warning" class="form-text text-danger" style="display: none;">–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ!</div>
      </div>
      <!-- Comments field on its own centered row with proportional width -->
      <div class="d-flex justify-content-center mb-3">
        <div class="flex-fill" style="max-width: 350px;">
          <label for="notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
          <textarea class="form-control" id="notes" name="notes" rows="3">{{ guest['notes'] or '' }}</textarea>
        </div>
      </div>
      <!-- Buttons row -->
      <div class="text-center">
        <button type="submit" class="btn btn-primary me-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a href="{{ url_for('view_guest', guest_id=guest['id']) }}" class="btn btn-soft-danger">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>

  <!-- Script for Bootstrap form validation -->
  <script>
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })()
  </script>

  <!-- Script for date picker activation and phone input mask -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Make clicking on the birth date container open the date picker
      var birthDateInput = document.getElementById('birth_date');
      if (birthDateInput) {
        // Attach click listener to the parent flex container
        var wrapper = birthDateInput.closest('div.flex-fill') || birthDateInput.parentElement;
        if (wrapper) {
          wrapper.addEventListener('click', function (e) {
            // If click is not directly on the input, trigger the picker
            if (typeof birthDateInput.showPicker === 'function') {
              birthDateInput.showPicker();
            } else {
              birthDateInput.focus();
            }
          });
        }
      }
      // Phone input with dynamic country code and formatting similar to booking form
      var countrySelect = document.getElementById('country_code');
      var phoneInput = document.getElementById('phone');
      var blacklistWarningEl = document.getElementById('blacklist-warning');
      // List of blacklisted numbers (digits only) passed from server
      var blacklistedDigits = {{ blacklisted_numbers|tojson|safe if blacklisted_numbers is defined else '[]' }};
      var currentMask = '';
      var currentLength = 0;

      function updatePlaceholder() {
        var selected = countrySelect.options[countrySelect.selectedIndex];
        currentMask = selected.getAttribute('data-mask');
        currentLength = parseInt(selected.getAttribute('data-length'), 10) || 10;
        phoneInput.placeholder = currentMask;
        // Clear phone field when mask changes
        phoneInput.value = '';
      }

      function formatNumber(digits) {
        var result = '';
        var digitIndex = 0;
        for (var i = 0; i < currentMask.length; i++) {
          var ch = currentMask[i];
          if (ch === 'X') {
            if (digitIndex < digits.length) {
              result += digits[digitIndex++];
            } else {
              break;
            }
          } else {
            result += ch;
          }
        }
        return result;
      }

      if (countrySelect && phoneInput) {
        // Initialize placeholder and mask
        updatePlaceholder();
        // If there are initial digits from the server, pre-fill the phone field
        var initialDigits = phoneInput.dataset.initialDigits || '';
        if (initialDigits) {
          var digits = initialDigits.replace(/\D/g, '');
          if (digits.length > currentLength) {
            digits = digits.slice(0, currentLength);
          }
          phoneInput.value = formatNumber(digits);
          // Also check blacklist for the initial full number
          var codeDigitsInit = countrySelect.value.replace(/\D/g, '');
          var fullInit = codeDigitsInit + digits;
          if (blacklistedDigits.indexOf(fullInit) !== -1) {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'block';
          } else {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'none';
          }
        }
        // On input, format according to mask and check blacklist
        phoneInput.addEventListener('input', function () {
          var digits = phoneInput.value.replace(/\D/g, '');
          if (digits.length > currentLength) {
            digits = digits.slice(0, currentLength);
          }
          phoneInput.value = formatNumber(digits);
          // Check if full phone (code + digits) is blacklisted
          var codeDigits = countrySelect.value.replace(/\D/g, '');
          var fullDigits = codeDigits + digits;
          if (blacklistedDigits.indexOf(fullDigits) !== -1) {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'block';
          } else {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'none';
          }
        });
        // Backspace handling: remove last digit ignoring separators
        phoneInput.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace') {
            e.preventDefault();
            var digits = phoneInput.value.replace(/\D/g, '');
            if (digits.length > 0) {
              digits = digits.slice(0, -1);
              phoneInput.value = formatNumber(digits);
              // Check blacklist again
              var codeDigits = countrySelect.value.replace(/\D/g, '');
              var fullDigits = codeDigits + digits;
              if (blacklistedDigits.indexOf(fullDigits) !== -1) {
                if (blacklistWarningEl) blacklistWarningEl.style.display = 'block';
              } else {
                if (blacklistWarningEl) blacklistWarningEl.style.display = 'none';
              }
            }
          }
        });
        // Keep cursor at end on focus
        phoneInput.addEventListener('focus', function () {
          var len = phoneInput.value.length;
          phoneInput.setSelectionRange(len, len);
        });
        // When country code changes, update placeholder and clear phone value, check blacklist
        countrySelect.addEventListener('change', function () {
          updatePlaceholder();
          var digits = phoneInput.value.replace(/\D/g, '');
          var codeDigits = countrySelect.value.replace(/\D/g, '');
          var fullDigits = codeDigits + digits;
          if (blacklistedDigits.indexOf(fullDigits) !== -1) {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'block';
          } else {
            if (blacklistWarningEl) blacklistWarningEl.style.display = 'none';
          }
        });
      }
    });
  </script>
{% endblock %}