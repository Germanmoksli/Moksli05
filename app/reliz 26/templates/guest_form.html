{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è{% endblock %}
{% block content %}
  <!-- –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —Ñ–æ—Ä–º—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ -->
  <div class="mx-auto" style="max-width: 600px;">
    <h2 class="text-primary fw-bold fs-4">–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è</h2>
  {# If a duplicate guest was detected, show a warning alert with options #}
    {% if duplicate_guest %}
  <div class="alert alert-warning d-flex flex-column align-items-start">
    <div class="mb-2">–ì–æ—Å—Ç—å —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:</div>
    <div class="fw-bold">{{ existing_guest.name }}{% if existing_guest.phone %} ‚Äî {{ existing_guest.phone | format_phone }}{% endif %}</div>
    <div class="mt-2">
      <a href="{{ url_for('view_guest', guest_id=existing_guest.id) }}" class="btn btn-outline-primary btn-sm me-2">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
      <a href="{{ url_for('add_booking', guest_id=existing_guest.id) }}" class="btn btn-outline-success btn-sm">–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
    </div>
    {# –ï—Å–ª–∏ –µ—Å—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—è, –æ—Ç–æ–±—Ä–∞–∑–∏–º –∏—Ö —Å–ø–∏—Å–æ–∫ #}
    {% if existing_bookings %}
    <div class="mt-3 w-100">
      <div class="fw-semibold mb-1">–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>–ö–≤–∞—Ä—Ç–∏—Ä–∞</th>
              <th>–ó–∞–µ–∑–¥</th>
              <th>–í—ã–µ–∑–¥</th>
              <th>–ö–æ–ª‚Äë–≤–æ —Å—É—Ç–æ–∫</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            </tr>
          </thead>
          <tbody>
            {% for b in existing_bookings %}
            <tr>
              <td>{{ b['room_number'] }}</td>
              <td>{{ b['check_in_date'] }}</td>
              <td>{{ b['check_out_date'] }}</td>
              <td>{{ b['nights'] }}</td>
              <td>{{ b['notes'] or '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
    {% endif %}
    <form method="post" class="needs-validation" novalidate>
    {# Preserve return_to if provided #}
    {% if return_to %}
    <input type="hidden" name="return_to" value="{{ return_to }}">
    {% endif %}
    <div class="mb-3">
      <label for="name" class="form-label">–ò–º—è</label>
      <input type="text" class="form-control" id="name" name="name" required
             value="{{ form_data.name if form_data is defined and form_data.name is not none else '' }}"
             list="guest-names">
      <div class="invalid-feedback">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è.</div>
    </div>
    {# Phone input with country code selector and masking #}
    <div class="mb-3 row g-2 align-items-end">
      <div class="col-auto clickable-field" onclick="this.querySelector('select').focus();">
        <label for="country_code" class="form-label">–ö–æ–¥</label>
        <select id="country_code" name="country_code" class="form-select">
          <!-- Country codes with flags and masks; default to Kazakhstan (+7) -->
          <option value="+7" data-mask="(XXX) XXX XX XX" data-length="10" data-flag="üá∞üáø" selected>üá∞üáø +7</option>
          <option value="+1" data-mask="(XXX) XXX-XXXX" data-length="10" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
          <option value="+44" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá¨üáß">üá¨üáß +44</option>
          <option value="+49" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá©üá™">üá©üá™ +49</option>
          <option value="+81" data-mask="(XXXX) XXX XXX" data-length="9" data-flag="üáØüáµ">üáØüáµ +81</option>
        </select>
      </div>
      <div class="col clickable-field" onclick="this.querySelector('input').focus();">
        <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" class="form-control" id="phone" name="phone" placeholder="(XXX) XXX XX XX"
               value="{{ form_data.phone if form_data is defined and form_data.phone is not none else '' }}"
               list="guest-phones">
      </div>
    </div>
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º -->
    <div class="mb-3 row g-2 align-items-end">
      <div class="col clickable-field" onclick="this.querySelector('input').focus();">
        <label for="extra_phone" class="form-label">–î–æ–ø. —Ç–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" class="form-control" id="extra_phone" name="extra_phone"
               placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä"
               value="{{ form_data.extra_phone if form_data is defined and form_data.extra_phone is not none else '' }}">
      </div>
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" name="email"
             value="{{ form_data.email if form_data is defined and form_data.email is not none else '' }}">
    </div>
    <div class="mb-3">
      <label for="notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
      <textarea class="form-control" id="notes" name="notes" rows="3">{{ form_data.notes if form_data is defined and form_data.notes is not none else '' }}</textarea>
    </div>
    <div class="text-center mt-3">
      <button type="submit" class="btn btn-primary me-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <a href="{{ url_for('list_guests') }}" class="btn btn-soft-danger">–û—Ç–º–µ–Ω–∞</a>
    </div>
    </form>
  </div>

  <!-- Script for Bootstrap form validation -->
  <script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })()
  </script>
  <!-- Script for phone mask in guest creation form -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var countrySelect = document.getElementById('country_code');
      var phoneInput = document.getElementById('phone');
      if (!countrySelect || !phoneInput) return;
      var currentMask = '';
      var currentLength = 0;
      function updatePlaceholder() {
        var selected = countrySelect.options[countrySelect.selectedIndex];
        currentMask = selected.getAttribute('data-mask');
        currentLength = parseInt(selected.getAttribute('data-length'), 10) || 10;
        phoneInput.placeholder = currentMask;
        // Clear the phone value when country code changes
        phoneInput.value = '';
      }
      function formatNumber(digits) {
        var result = '';
        var digitIndex = 0;
        for (var i = 0; i < currentMask.length; i++) {
          var ch = currentMask[i];
          if (ch === 'X') {
            if (digitIndex < digits.length) {
              result += digits[digitIndex++];
            } else {
              break;
            }
          } else {
            result += ch;
          }
        }
        return result;
      }
      countrySelect.addEventListener('change', updatePlaceholder);
      phoneInput.addEventListener('input', function () {
        var digits = phoneInput.value.replace(/\D/g, '');
        if (digits.length > currentLength) {
          digits = digits.slice(0, currentLength);
        }
        phoneInput.value = formatNumber(digits);
      });
      phoneInput.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {
          e.preventDefault();
          var digits = phoneInput.value.replace(/\D/g, '');
          if (digits.length > 0) {
            digits = digits.slice(0, -1);
            phoneInput.value = formatNumber(digits);
          }
        }
      });
      phoneInput.addEventListener('focus', function () {
        var len = phoneInput.value.length;
        phoneInput.setSelectionRange(len, len);
      });
      updatePlaceholder();
    });
  </script>
{% endblock %}