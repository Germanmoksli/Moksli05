{% extends "base.html" %}
{% block title %}Информация о госте{% endblock %}
{% block content %}
  <div class="mx-auto" style="max-width: 800px;">
    <h2 class="text-primary fw-bold fs-4 mb-3">Информация о госте</h2>
    {% if guest %}
        <div class="card mb-4">
        <div class="card-body position-relative">
          <!-- Edit button in top right corner -->
          <div class="position-absolute top-0 end-0 m-2">
            <a href="{{ url_for('edit_guest', guest_id=guest['id']) }}" class="btn btn-primary btn-sm">Редактировать</a>
          </div>
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="card-title mb-3 fs-4 fw-bold">
                {{ display_name or 'Без имени' }}
                {% if blacklisted %}
                  {#
                    Display the blacklist badge with a tooltip showing the reason and date the
                    guest was added to the blacklist. The tooltip is enabled via
                    data-bs-toggle and uses HTML content for formatting. If no reason or date
                    is available, default to an empty string.
                  #}
                  <span class="badge bg-danger text-white ms-2"
                        data-bs-toggle="tooltip"
                        data-bs-html="true"
                        title="{{ (blacklist_reason or '') | replace('\n', '<br>') }}{% if blacklist_added_at %} ({{ blacklist_added_at }}){% endif %}">
                    ЧС
                  </span>
                {% endif %}
              </h5>
              <p class="mb-1"><strong>Телефон:</strong> {{ guest['phone'] | format_phone }}</p>
              {# Display additional phone number if available #}
              {% if guest['extra_phone'] %}
                <p class="mb-1"><strong>Доп. телефон:</strong> {{ guest['extra_phone'] | format_phone }}</p>
              {% endif %}
              {% if guest['birth_date'] %}
                <p class="mb-1"><strong>Дата рождения:</strong> {{ guest['birth_date'] }}</p>
              {% endif %}
              {% if guest['email'] %}
                <p class="mb-1"><strong>Email:</strong> {{ guest['email'] }}</p>
              {% endif %}
              {% if last_comment %}
                <p class="mb-1">
                  <strong>Комментарий:</strong>
                  {{ last_comment }}
                  <!-- Button to open comments modal -->
                  <button type="button" class="btn btn-sm btn-light border ms-2" data-bs-toggle="modal" data-bs-target="#commentsModal">
                    Все комментарии
                  </button>
                </p>
              {% else %}
                <p class="mb-1 text-muted">Комментариев нет</p>
              {% endif %}
              <p class="mb-1"><strong>Количество бронирований:</strong>
                {{ bookings|length if bookings is defined else 0 }}
              </p>
            </div>
            {% if guest['photo'] %}
              <div class="ms-3 text-end">
                <img src="{{ url_for('static', filename='uploads/' + guest['photo']) }}" alt="Фото гостя" style="max-width: 150px; max-height: 150px;" class="img-thumbnail">
              </div>
            {% endif %}
          </div>
          <!-- Removed edit button from bottom, moved to top right -->
        </div>
      </div>
      {% if bookings %}
        <h4 class="fs-5 mb-2">Бронирования</h4>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Квартира</th>
                <th>Дата заезда</th>
                <th>Дата выезда</th>
                <th>Статус депозита</th>
                <th>Сумма депозита</th>
                <th>Комментарий</th>
                <th>Менеджер</th>
              </tr>
            </thead>
            <tbody>
              {% for b in bookings %}
                <tr>
                  <td>{{ b['id'] }}</td>
                  <td>{{ b['room_number'] }}</td>
                  <td>{{ b['check_in_date'] }}</td>
                  <td>{{ b['check_out_date'] }}</td>
                  <td>
                    {% if b['status'] == 'paid' %}
                      Оплачен
                    {% elif b['status'] == 'withheld' %}
                      Удержан
                    {% elif b['status'] == 'returned' %}
                      Возвращён
                    {% else %}
                      {{ b['status'] }}
                    {% endif %}
                  </td>
                <td>{{ (b['paid_amount']|currency) if b['paid_amount'] else '' }}</td>
                <td>{{ b['notes'] or '' }}</td>
                <td>{{ b['manager_name'] or '' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">Бронирований не найдено.</p>
      {% endif %}
    {% else %}
      <div class="alert alert-warning">Гость с номером {{ full_phone | format_phone }} не найден.</div>
    {% endif %}
    
    <!-- Modal to display all comments -->
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="commentsModalLabel">Все комментарии</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            {% if all_comments %}
              <ul class="list-group">
              {% for c in all_comments %}
                <li class="list-group-item">
                  <small class="text-muted">{{ c.created_at }}</small><br>
                  {{ c.comment }}
                </li>
              {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">Комментариев нет.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- Button to return to the list of guests instead of the calendar -->
    <a href="{{ url_for('list_guests') }}" class="btn btn-soft-primary mt-3">Назад к гостям</a>
  </div>
{% endblock %}