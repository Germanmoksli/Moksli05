{% extends "base.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}
{% block content %}
  <div class="mx-auto" style="max-width: 600px;">
    <h2 class="text-primary fw-bold fs-4 mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: —É—Å–∏–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä–∏–≥–ª—É—à–∞–µ–º —Ç–µ–∫—Å—Ç -->
    <style>
      .booking-form .form-label {
        font-weight: 600;
        padding-bottom: 2px;
      }
      .booking-form .form-control {
        color: #6c757d;
      }
    </style>
    <div class="booking-form">
      <form method="post" class="needs-validation" novalidate>
        {# –ü–µ—Ä–µ–¥–∞—ë–º guest_id —Å–∫—Ä—ã—Ç—ã–º –ø–æ–ª–µ–º, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –≥–æ—Å—Ç—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Å—Ç—è –∑–∞–Ω–æ–≤–æ #}
        <input type="hidden" name="guest_id" value="{{ booking['guest_id'] }}">
        {# –°–æ—Ö—Ä–∞–Ω—è–µ–º scroll_date, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω—É–∂–Ω–æ–π –¥–∞—Ç–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ #}
        {% if scroll_date %}
          <input type="hidden" name="scroll_date" value="{{ scroll_date }}">
        {% endif %}
        <!-- 1. –ò–º—è –≥–æ—Å—Ç—è (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å) -->
        <div class="mb-3 clickable-field" onclick="this.querySelector('input').focus();">
          <label for="guest_name" class="form-label">–ò–º—è</label>
          <div class="position-relative">
            {# –ò–º—è –≥–æ—Å—Ç—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ #}
            <input type="text" class="form-control" id="guest_name" name="guest_name" value="{{ guest_name }}" disabled style="padding-right: 2.25rem;">
            {# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤–≤–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ–ª–µ; –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è #}
          </div>
        </div>
        <!-- 1b. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è: –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥ –∏–º–µ–Ω–µ–º. –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ guest_extra_phone. -->
        <div class="mb-3 clickable-field" onclick="this.querySelector('input').focus();">
          <label for="extra_phone" class="form-label">–î–æ–ø. —Ç–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" class="form-control" id="extra_phone" name="extra_phone"
                 placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä" value="{{ guest_extra_phone }}">
        </div>

        <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä, –æ—Ñ–æ—Ä–º–∏–≤—à–∏–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è) -->
        <div class="mb-3 clickable-field">
          <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
          <input type="text" class="form-control" value="{{ manager_name or '' }}" disabled>
        </div>
        <!-- 2. –î–∞—Ç—ã –∑–∞–µ–∑–¥–∞ –∏ –≤—ã–µ–∑–¥–∞ -->
        <div class="mb-3 row g-2 align-items-end">
          <div class="col clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
            <label for="check_in" class="form-label">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
            <input type="date" class="form-control" id="check_in" name="check_in" required value="{{ booking['check_in_date'] }}">
            <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∑–∞–µ–∑–¥–∞.</div>
          </div>
          <div class="col clickable-field" onclick="this.querySelector('input').showPicker ? this.querySelector('input').showPicker() : this.querySelector('input').focus();">
            <label for="check_out" class="form-label">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
            <input type="date" class="form-control" id="check_out" name="check_out" required value="{{ booking['check_out_date'] }}">
            <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤—ã–µ–∑–¥–∞.</div>
          </div>
        </div>
        <!-- 3. –í—ã–±–æ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã -->
        <div class="mb-3 clickable-field" onclick="this.querySelector('select').focus();">
          <label for="room_id" class="form-label">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
          <select class="form-select" id="room_id" name="room_id" required>
            <option value="" disabled {% if not selected_room_id %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É</option>
            {% for r in rooms %}
              <option value="{{ r['id'] }}" {% if selected_room_id and selected_room_id == r['id'] %}selected{% endif %}>{{ r['room_number'] }}</option>
            {% endfor %}
          </select>
          <div class="invalid-feedback">–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É.</div>
        </div>
        <!-- 4. –°—É–º–º–∞ –∑–∞ —Å—É—Ç–∫–∏ –∏ –æ–±—â–∞—è —Å—É–º–º–∞ -->
        <div class="mb-3 row g-2 align-items-end">
          <div class="col clickable-field" onclick="this.querySelector('input').focus();">
            <label for="total_amount" class="form-label">–¶–µ–Ω–∞ –∑–∞ —Å—É—Ç–∫–∏ (‚Ç∏)</label>
            <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount" value="{{ rate_value }}">
          </div>
          <div class="col clickable-field" onclick="this.querySelector('input').focus();">
            <label for="total_price_display" class="form-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚Ç∏)</label>
            <input type="text" class="form-control" id="total_price_display" value="{{ total_price_value }}" readonly>
          </div>
        </div>
        <!-- 5. –°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å –¥–µ–ø–æ–∑–∏—Ç–∞ -->
        <div class="mb-3 row g-2 align-items-end">
          <div class="col clickable-field" onclick="this.querySelector('input').focus();">
            <label for="paid_amount" class="form-label">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ (‚Ç∏)</label>
            <input type="number" step="0.01" class="form-control" id="paid_amount" name="paid_amount" value="{{ booking['paid_amount'] }}">
          </div>
          <div class="col clickable-field" onclick="this.querySelector('select').focus();">
            <label for="deposit_status" class="form-label">–°—Ç–∞—Ç—É—Å –¥–µ–ø–æ–∑–∏—Ç–∞</label>
            <select id="deposit_status" name="deposit_status" class="form-select">
              <option value="paid" data-class="bg-warning-subtle text-dark" {% if booking['status'] == 'paid' %}selected{% endif %}>–û–ø–ª–∞—á–µ–Ω</option>
              <option value="withheld" data-class="bg-danger-subtle text-dark" {% if booking['status'] == 'withheld' %}selected{% endif %}>–£–¥–µ—Ä–∂–∞–Ω</option>
              <option value="returned" data-class="bg-success-subtle text-dark" {% if booking['status'] == 'returned' %}selected{% endif %}>–í–æ–∑–≤—Ä–∞—â–µ–Ω</option>
            </select>
          </div>
        </div>
        <!-- 6. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
        <div class="mb-3 clickable-field" onclick="this.querySelector('textarea').focus();">
          <label for="notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
          <textarea class="form-control" id="notes" name="notes" rows="3">{{ booking['notes'] }}</textarea>
        </div>
        <!-- 7. –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–º–µ–Ω–∞ -->
        <div class="text-center mb-3">
          <button type="submit" class="btn btn-primary me-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          {#
            –°—Å—ã–ª–∫–∞ –û—Ç–º–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –∞ –Ω–µ –≤ —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.
            –ï—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω –ø–µ—Ä–µ–¥–∞–Ω—ã scroll_date, scroll_year –∏ scroll_month (–∫–æ–≥–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            –±—ã–ª–æ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω—É–∂–Ω—ã–π –º–µ—Å—è—Ü.
            –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
          #}
          {% if scroll_date and scroll_year and scroll_month %}
            <a href="{{ url_for('calendar_view', year=scroll_year, month=scroll_month, scroll_date=scroll_date) }}" class="btn btn-soft-danger">–û—Ç–º–µ–Ω–∞</a>
          {% else %}
            <a href="{{ url_for('calendar_view') }}" class="btn btn-soft-danger">–û—Ç–º–µ–Ω–∞</a>
          {% endif %}
        </div>
      </form>
      <!-- 8. –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
      <div class="text-center mt-3">
        <form method="post"
              action="{{ url_for('delete_booking', booking_id=booking['id']) }}"
              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?');"
              class="d-inline">
          {% if scroll_date %}
            <input type="hidden" name="scroll_date" value="{{ scroll_date }}">
          {% endif %}
          <button type="submit" class="p-0 text-secondary"
                  style="background: none; border: none; border-bottom: 2px solid #6c757d; text-decoration: none;">
            –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          </button>
        </form>
      </div>
    </div>
  </div>
  <!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script>
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })();
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
    document.addEventListener('DOMContentLoaded', function () {
      var select = document.getElementById('deposit_status');
      if (select) {
        function updateDepositClass() {
          select.classList.remove('bg-warning-subtle', 'bg-success-subtle', 'bg-danger-subtle', 'text-dark');
          var opt = select.options[select.selectedIndex];
          var cls = opt.getAttribute('data-class');
          if (cls) {
            cls.split(/\s+/).forEach(function (c) {
              if (c) select.classList.add(c);
            });
          }
        }
        updateDepositClass();
        select.addEventListener('change', updateDepositClass);
      }
    });
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∞—Ç –∏ —Ü–µ–Ω—ã –∑–∞ —Å—É—Ç–∫–∏
    document.addEventListener('DOMContentLoaded', function () {
      var rateInput = document.getElementById('total_amount');
      var checkInInput = document.getElementById('check_in');
      var checkOutInput = document.getElementById('check_out');
      var totalDisplay = document.getElementById('total_price_display');
      function updateTotalPrice() {
        var rate = parseFloat(rateInput.value);
        var checkInDate = new Date(checkInInput.value);
        var checkOutDate = new Date(checkOutInput.value);
        if (isNaN(rate) || !checkInInput.value || !checkOutInput.value) {
          return;
        }
        var diffMs = checkOutDate - checkInDate;
        var nights = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        if (nights <= 0) {
          if (nights < 0) {
            totalDisplay.value = '';
            return;
          }
          nights = 1;
        }
        var total = (rate * nights).toFixed(2);
        totalDisplay.value = total;
      }
      ['change', 'input'].forEach(function (evt) {
        rateInput.addEventListener(evt, updateTotalPrice);
        checkInInput.addEventListener(evt, updateTotalPrice);
        checkOutInput.addEventListener(evt, updateTotalPrice);
      });
      updateTotalPrice();
    });
  </script>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
  <div class="modal fade" id="extraPhoneModal" tabindex="-1" aria-labelledby="extraPhoneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="extraPhoneModalLabel">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</label>
            <div class="row g-2">
              <div class="col-auto">
                <select id="extra_country_code" class="form-select">
                  <option value="+7" data-mask="(XXX) XXX XX XX" data-length="10" data-flag="üá∞üáø">üá∞üáø +7</option>
                  <option value="+1" data-mask="(XXX) XXX-XXXX" data-length="10" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
                  <option value="+44" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá¨üáß">üá¨üáß +44</option>
                  <option value="+49" data-mask="(XXXX) XXX XXXX" data-length="10" data-flag="üá©üá™">üá©üá™ +49</option>
                  <option value="+81" data-mask="(XXXX) XXX XXX" data-length="9" data-flag="üáØüáµ">üáØüáµ +81</option>
                </select>
              </div>
              <div class="col">
                <input type="tel" class="form-control" id="extra_phone_input" placeholder="(XXX) XXX XX XX">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" id="save_extra_phone_btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
        <!-- –ü–æ–ª–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥ –∏–º–µ–Ω–µ–º -->
        <div class="mb-3 clickable-field" onclick="this.querySelector('input').focus();">
          <label for="extra_phone" class="form-label">–î–æ–ø. —Ç–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" class="form-control" id="extra_phone" name="extra_phone" value="{{ guest_extra_phone }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä">
        </div>
    </div>
  </div>
  <script>
    // –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–≤–æ–¥–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –º–∞—Å–∫–∏
    document.addEventListener('DOMContentLoaded', function () {
      var extraCountry = document.getElementById('extra_country_code');
      var extraInput = document.getElementById('extra_phone_input');
      var hiddenExtra = document.getElementById('extra_phone');
      var extraMask = '(XXX) XXX XX XX';
      var extraLength = 10;
      function updateExtraMask() {
        var selected = extraCountry.options[extraCountry.selectedIndex];
        extraMask = selected.getAttribute('data-mask');
        extraLength = parseInt(selected.getAttribute('data-length'));
        extraInput.value = '';
        extraInput.placeholder = extraMask;
      }
      function formatExtra(digits) {
        var result = '';
        var digitIndex = 0;
        for (var i = 0; i < extraMask.length; i++) {
          var ch = extraMask[i];
          if (ch === 'X') {
            if (digitIndex < digits.length) {
              result += digits[digitIndex++];
            } else {
              break;
            }
          } else {
            result += ch;
          }
        }
        return result;
      }
      extraCountry.addEventListener('change', updateExtraMask);
      updateExtraMask();
      extraInput.addEventListener('input', function () {
        var digits = extraInput.value.replace(/\D/g, '');
        if (digits.length > extraLength) {
          digits = digits.slice(0, extraLength);
        }
        extraInput.value = formatExtra(digits);
      });
      extraInput.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {
          e.preventDefault();
          var digits = extraInput.value.replace(/\D/g, '');
          if (digits.length > 0) {
            digits = digits.slice(0, -1);
            extraInput.value = formatExtra(digits);
          }
        }
      });
      extraInput.addEventListener('focus', function () {
        var len = extraInput.value.length;
        extraInput.setSelectionRange(len, len);
      });
      document.getElementById('save_extra_phone_btn').addEventListener('click', function () {
        var code = extraCountry.value.replace(/\D/g, '');
        var digits = extraInput.value.replace(/\D/g, '');
        if (digits.length === 0) {
          hiddenExtra.value = '';
        } else {
          hiddenExtra.value = '+' + code + digits;
        }
        var modalEl = document.getElementById('extraPhoneModal');
        var modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();
      });
    });
  </script>
{% endblock %}